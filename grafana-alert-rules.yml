# DreamSeed Grafana 알림 규칙
groups:
  - name: dreamseed-backup
    rules:
      - alert: DreamSeedBackupFailed
        expr: node_systemd_unit_state{name="dreamseed-backup.service",state="failed"} == 1
        for: 5m
        labels:
          severity: critical
          service: dreamseed-backup
        annotations:
          summary: "DreamSeed 백업 실패"
          description: "DreamSeed 데이터베이스 백업이 실패했습니다. 서버: {{ $labels.instance }}"
          runbook_url: "https://docs.dreamseed.com/troubleshooting/backup-issues"

      - alert: DreamSeedBackupTooOld
        expr: time() - node_systemd_unit_state{name="dreamseed-backup.service"} > 86400
        for: 10m
        labels:
          severity: warning
          service: dreamseed-backup
        annotations:
          summary: "DreamSeed 백업이 오래되었습니다"
          description: "DreamSeed 백업이 24시간 이상 실행되지 않았습니다. 서버: {{ $labels.instance }}"

  - name: dreamseed-api
    rules:
      - alert: DreamSeedAPIDown
        expr: up{job="dreamseed-api"} == 0
        for: 2m
        labels:
          severity: critical
          service: dreamseed-api
        annotations:
          summary: "DreamSeed API 서비스 중단"
          description: "DreamSeed API 서비스가 다운되었습니다. 서버: {{ $labels.instance }}"

      - alert: DreamSeedAPIHighErrorRate
        expr: rate(dreamseed_requests_total{status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: dreamseed-api
        annotations:
          summary: "DreamSeed API 오류율 높음"
          description: "DreamSeed API의 5xx 오류율이 10%를 초과했습니다. 서버: {{ $labels.instance }}"

      - alert: DreamSeedAPIHighResponseTime
        expr: histogram_quantile(0.95, rate(dreamseed_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          service: dreamseed-api
        annotations:
          summary: "DreamSeed API 응답 시간 높음"
          description: "DreamSeed API의 95% 응답 시간이 2초를 초과했습니다. 서버: {{ $labels.instance }}"

  - name: dreamseed-redis
    rules:
      - alert: DreamSeedRedisDown
        expr: up{job="redis"} == 0
        for: 2m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "DreamSeed Redis 서비스 중단"
          description: "DreamSeed Redis 서비스가 다운되었습니다. 서버: {{ $labels.instance }}"

      - alert: DreamSeedRedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "DreamSeed Redis 메모리 사용량 높음"
          description: "DreamSeed Redis 메모리 사용량이 90%를 초과했습니다. 서버: {{ $labels.instance }}"

  - name: dreamseed-system
    rules:
      - alert: DreamSeedHighCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "DreamSeed 서버 CPU 사용량 높음"
          description: "DreamSeed 서버의 CPU 사용량이 80%를 초과했습니다. 서버: {{ $labels.instance }}"

      - alert: DreamSeedHighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "DreamSeed 서버 메모리 사용량 높음"
          description: "DreamSeed 서버의 메모리 사용량이 85%를 초과했습니다. 서버: {{ $labels.instance }}"

      - alert: DreamSeedLowDiskSpace
        expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) * 100 > 90
        for: 5m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "DreamSeed 서버 디스크 공간 부족"
          description: "DreamSeed 서버의 디스크 사용량이 90%를 초과했습니다. 서버: {{ $labels.instance }}"

