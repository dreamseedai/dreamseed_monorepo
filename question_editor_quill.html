<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamSeedAI Question Editor - Quill.js + ChemDoodle</title>
    
    <!-- Quill.js CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
    
    <!-- ChemDoodle CSS -->
    <link rel="stylesheet" href="https://unpkg.com/chemdoodle@9.3.0/ChemDoodleWeb.css">
    
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            },
            startup: {
                typeset: false
            }
        };
    </script>
    
    <!-- MathJax Script -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" 
            onerror="loadLocalMathJax()"></script>
    
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --error-color: #dc3545;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --accent-color: #4dabf7;
            --success-color: #51cf66;
            --warning-color: #ffd43b;
            --error-color: #ff6b6b;
            --shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .left-panel {
            width: 350px;
            min-width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .search-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        
        .input-group input {
            flex: 1;
            min-width: 80px;
        }
        
        .input-group button {
            white-space: nowrap;
            min-width: 60px;
        }

        input, button {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        button {
            background: var(--accent-color);
            color: white;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        .status-bar {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            font-size: 12px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .status-ok { color: var(--success-color); }
        .status-fail { color: var(--error-color); }
        .status-loading { color: var(--warning-color); }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            border-bottom-color: var(--accent-color);
            background: var(--bg-primary);
        }

        .tab-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Quill Editor Styles */
        .editor-container {
            height: 400px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
        }

        .ql-editor {
            color: var(--text-primary);
            background: var(--bg-primary);
        }

        .ql-toolbar {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .ql-toolbar .ql-stroke {
            stroke: var(--text-primary);
        }

        .ql-toolbar .ql-fill {
            fill: var(--text-primary);
        }

        .ql-toolbar button:hover {
            background: var(--bg-primary);
        }
        
        /* Custom Toolbar Buttons */
        .ql-toolbar button[title="수식 삽입"],
        .ql-toolbar button[title="화학 구조 삽입"] {
            background: var(--accent-color);
            color: white;
            border: 1px solid var(--accent-color);
            border-radius: 3px;
            margin: 0 2px;
            font-weight: bold;
        }
        
        .ql-toolbar button[title="수식 삽입"]:hover,
        .ql-toolbar button[title="화학 구조 삽입"]:hover {
            background: #0056b3;
            border-color: #0056b3;
        }

        /* Custom Blot Styles */
        .ql-mathjax {
            display: inline-block;
            margin: 0 2px;
            vertical-align: middle;
        }

        .ql-chem {
            display: inline-block;
            margin: 0 2px;
            vertical-align: middle;
            max-width: 200px;
            height: auto;
        }

        /* Dark Theme Overrides */
        [data-theme="dark"] .ql-editor {
            color: var(--text-primary);
            background: var(--bg-primary);
        }

        [data-theme="dark"] .ql-toolbar {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .ql-toolbar .ql-stroke {
            stroke: var(--text-primary);
        }

        [data-theme="dark"] .ql-toolbar .ql-fill {
            fill: var(--text-primary);
        }

        /* ChemDoodle Modal */
        .chem-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
        }

        .chem-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            min-width: 600px;
            min-height: 400px;
        }

        .chem-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .chem-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-primary);
        }

        .chem-sketcher-container {
            width: 100%;
            height: 300px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .chem-modal-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* List Styles */
        .list-item {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .list-item:hover {
            background: var(--bg-secondary);
        }

        .list-item.selected {
            background: var(--accent-color);
            color: white;
        }

        /* Preview Styles */
        .preview-content {
            background: var(--bg-primary);
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-height: 200px;
        }

        /* Resizable Panels */
        .resize-handle {
            width: 4px;
            background: var(--border-color);
            cursor: col-resize;
            transition: background 0.2s;
        }
        
        .resize-handle:hover {
            background: var(--accent-color);
        }
        
        /* Inline Editing */
        .editable-content {
            position: relative;
            cursor: pointer;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 0.5rem;
            transition: all 0.2s;
        }
        
        .editable-content:hover {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
        }
        
        .editable-content.editing {
            border-color: var(--accent-color);
            background: var(--bg-primary);
        }
        
        .edit-indicator {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .editable-content:hover .edit-indicator {
            opacity: 1;
        }
        
        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-title {
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .section-actions {
            display: flex;
            gap: 0.25rem;
        }
        
        .section-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            min-width: auto;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .left-panel {
                width: 100%;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel -->
        <div class="left-panel" id="leftPanel">
            <div class="header">
                <h3>Question Editor</h3>
                <button id="themeToggle" onclick="toggleTheme()">🌙</button>
            </div>
            
            <div class="search-section">
                <div class="input-group">
                    <input type="text" id="searchInput" placeholder="Original ID" value="11384">
                    <input type="number" id="rangeCount" placeholder="Count" min="1" max="100">
                    <button onclick="searchByOriginalId()">검색</button>
                    <button onclick="searchRangeList()">리스트</button>
                </div>
            </div>
            
            <div class="status-bar">
                <div class="status-item">
                    <span>MathJax:</span>
                    <span id="mathjaxStatus" class="status-loading">Loading...</span>
                </div>
                <div class="status-item">
                    <span>ChemDoodle:</span>
                    <span id="chemStatus" class="status-loading">Loading...</span>
                </div>
                <div class="status-item">
                    <span>Network:</span>
                    <span id="networkStatus" class="status-loading">Loading...</span>
                </div>
            </div>
            
            <div id="listContainer" style="flex: 1; overflow-y: auto; padding: 1rem;">
                <!-- List items will be populated here -->
            </div>
        </div>
        
        <!-- Resize Handle -->
        <div class="resize-handle" id="resizeHandle"></div>
        
        <!-- Right Panel -->
        <div class="right-panel" id="rightPanel">
            <div class="header">
                <h3 id="questionTitle">Question Editor</h3>
            </div>
            
            <div class="content-area">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('view')">View</div>
                    <div class="tab" onclick="switchTab('edit')">Edit</div>
                    <div class="tab" onclick="switchTab('preview')">Preview</div>
                    <div class="tab" onclick="switchTab('raw')">Raw JSON</div>
                </div>
                
                <!-- View Tab -->
                <div id="viewTab" class="tab-content active">
                    <div id="viewContent">
                        <p>검색하여 문제를 선택하세요.</p>
                    </div>
                </div>
                
                <!-- Edit Tab -->
                <div id="editTab" class="tab-content">
                    <div class="editor-container" id="questionEditor"></div>
                    <div style="margin-top: 1rem;">
                        <button onclick="saveCurrent()">저장</button>
                        <button onclick="resetEditor()">원복</button>
                    </div>
                </div>
                
                <!-- Preview Tab -->
                <div id="previewTab" class="tab-content">
                    <div id="previewContent" class="preview-content">
                        <p>편집 내용을 미리보기합니다.</p>
                    </div>
                </div>
                
                <!-- Raw JSON Tab -->
                <div id="rawTab" class="tab-content">
                    <pre id="rawContent" style="background: var(--bg-secondary); padding: 1rem; border-radius: 4px; overflow: auto; max-height: 500px;"></pre>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ChemDoodle Modal -->
    <div id="chemModal" class="chem-modal">
        <div class="chem-modal-content">
            <div class="chem-modal-header">
                <h3>화학 구조 편집</h3>
                <button class="chem-modal-close" onclick="closeChemModal()">&times;</button>
            </div>
            <div id="chemSketcher" class="chem-sketcher-container"></div>
            <div class="chem-modal-actions">
                <button onclick="insertChemStructure()">삽입</button>
                <button onclick="closeChemModal()">취소</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js" onerror="loadLocalQuill()"></script>
    <script src="https://unpkg.com/chemdoodle@9.3.0/ChemDoodleWeb.js" onerror="loadLocalChemDoodle()"></script>
    
    <script>
        // Global variables
        let quill;
        let currentData = null;
        let originalContent = null;
        let mathjaxReady = false;
        let chemReady = false;
        let networkOnline = false;
        
        // API Configuration
        const API_BASE = 'http://127.0.0.1:8008/api';
        const IMG_BASE = '/images/editor/';
        
        // ChemDoodle Sketcher
        let chemSketcher = null;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            initMathJax();
            initChemDoodle();
            initQuill();
            checkNetworkStatus();
            loadInitialData();
        });
        
        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeButton(savedTheme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
        }
        
        function updateThemeButton(theme) {
            const button = document.getElementById('themeToggle');
            button.textContent = theme === 'dark' ? '☀️' : '🌙';
        }
        
        // MathJax Initialization
        function initMathJax() {
            if (window.MathJax && window.MathJax.typesetPromise) {
                mathjaxReady = true;
                document.getElementById('mathjaxStatus').innerHTML = '<span class="status-ok">OK</span>';
            } else {
                setTimeout(initMathJax, 100);
            }
        }
        
        function loadLocalMathJax() {
            console.warn('[MATHJAX] CDN 실패, 로컬 로드 시도');
            const script = document.createElement('script');
            script.src = '/assets/mathjax/tex-mml-chtml.js';
            script.onerror = () => {
                console.error('[MATHJAX] 로컬 로드도 실패');
                document.getElementById('mathjaxStatus').innerHTML = '<span class="status-fail">FAIL</span>';
            };
            document.head.appendChild(script);
        }
        
        // ChemDoodle Initialization
        function initChemDoodle() {
            if (window.ChemDoodle) {
                chemReady = true;
                document.getElementById('chemStatus').innerHTML = '<span class="status-ok">OK</span>';
            } else {
                setTimeout(initChemDoodle, 100);
            }
        }
        
        function loadLocalChemDoodle() {
            console.warn('[CHEM] CDN 실패, 로컬 로드 시도');
            const css = document.createElement('link');
            css.rel = 'stylesheet';
            css.href = '/assets/chemdoodle/ChemDoodleWeb.css';
            document.head.appendChild(css);
            
            const script = document.createElement('script');
            script.src = '/assets/chemdoodle/ChemDoodleWeb.js';
            script.onerror = () => {
                console.error('[CHEM] 로컬 로드도 실패');
                document.getElementById('chemStatus').innerHTML = '<span class="status-fail">FAIL</span>';
            };
            document.head.appendChild(script);
        }
        
        // Quill Editor Initialization
        function initQuill() {
            // Register custom blots
            registerCustomBlots();
            
            // Initialize Quill
            quill = new Quill('#questionEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'header': [1, 2, 3, false] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['blockquote', 'code-block'],
                        ['link', 'image'],
                        ['formula', 'chem'], // Custom buttons
                        ['clean']
                    ]
                },
                placeholder: '문제 내용을 입력하세요...'
            });
            
            // Add custom toolbar handlers
            const toolbar = quill.getModule('toolbar');
            
            // Add custom buttons to toolbar
            const formulaButton = document.createElement('button');
            formulaButton.innerHTML = 'fx';
            formulaButton.title = '수식 삽입';
            formulaButton.onclick = insertMathFormula;
            
            const chemButton = document.createElement('button');
            chemButton.innerHTML = '🧪';
            chemButton.title = '화학 구조 삽입';
            chemButton.onclick = openChemModal;
            
            // Insert custom buttons into toolbar
            const toolbarContainer = quill.container.querySelector('.ql-toolbar');
            if (toolbarContainer) {
                const cleanButton = toolbarContainer.querySelector('.ql-clean');
                if (cleanButton) {
                    cleanButton.parentNode.insertBefore(formulaButton, cleanButton);
                    cleanButton.parentNode.insertBefore(chemButton, cleanButton);
                } else {
                    toolbarContainer.appendChild(formulaButton);
                    toolbarContainer.appendChild(chemButton);
                }
            }
            
            // Listen for content changes
            quill.on('text-change', updatePreview);
        }
        
        function loadLocalQuill() {
            console.warn('[QUILL] CDN 실패, 로컬 로드 시도');
            const script = document.createElement('script');
            script.src = '/assets/quill/quill.min.js';
            script.onerror = () => {
                console.error('[QUILL] 로컬 로드도 실패');
            };
            document.head.appendChild(script);
        }
        
        // Custom Blots Registration
        function registerCustomBlots() {
            // MathJax Formula Blot
            const MathJaxBlot = Quill.import('blots/embed');
            
            class MathJaxFormula extends MathJaxBlot {
                static create(value) {
                    const node = super.create();
                    node.setAttribute('class', 'ql-mathjax');
                    node.setAttribute('data-latex', value);
                    node.contentEditable = false;
                    
                    // Render with MathJax
                    if (mathjaxReady) {
                        renderMathJaxFormula(node, value);
                    } else {
                        node.innerHTML = `$${value}$`;
                    }
                    
                    return node;
                }
                
                static value(node) {
                    return node.getAttribute('data-latex');
                }
            }
            
            MathJaxFormula.blotName = 'mathjax';
            MathJaxFormula.tagName = 'span';
            Quill.register(MathJaxFormula);
            
            // ChemDoodle Structure Blot
            const ChemBlot = Quill.import('blots/embed');
            
            class ChemStructure extends ChemBlot {
                static create(value) {
                    const node = super.create();
                    node.setAttribute('class', 'ql-chem');
                    node.setAttribute('data-smiles', value);
                    node.contentEditable = false;
                    
                    // Render with ChemDoodle
                    if (chemReady) {
                        renderChemStructure(node, value);
                    } else {
                        node.innerHTML = `[Chem: ${value}]`;
                    }
                    
                    return node;
                }
                
                static value(node) {
                    return node.getAttribute('data-smiles');
                }
            }
            
            ChemStructure.blotName = 'chem';
            ChemStructure.tagName = 'img';
            Quill.register(ChemStructure);
        }
        
        // MathJax Rendering
        function renderMathJaxFormula(node, latex) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `$$${latex}$$`;
            
            MathJax.typesetPromise([tempDiv]).then(() => {
                const mathElement = tempDiv.querySelector('.MathJax');
                if (mathElement) {
                    node.innerHTML = mathElement.outerHTML;
                } else {
                    node.innerHTML = `$$${latex}$$`;
                }
            }).catch(() => {
                node.innerHTML = `$$${latex}$$`;
            });
        }
        
        // ChemDoodle Rendering
        function renderChemStructure(node, smiles) {
            if (!window.ChemDoodle) {
                node.innerHTML = `[Chem: ${smiles}]`;
                return;
            }
            
            try {
                // Create a temporary canvas
                const canvas = new ChemDoodle.ViewerCanvas('tempChemCanvas', 200, 150);
                canvas.styles.backgroundColor = 'transparent';
                
                // Parse SMILES and draw
                ChemDoodle.iChemLabs.readSMILES(smiles, {}, function(data) {
                    if (data && data.molecules && data.molecules[0]) {
                        canvas.loadMolecule(data.molecules[0]);
                        const pngData = ChemDoodle.io.png.string(canvas);
                        node.src = pngData;
                    } else {
                        node.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
                    }
                });
            } catch (error) {
                console.warn('[CHEM] 렌더링 실패:', error);
                node.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
            }
        }
        
        // Custom Toolbar Handlers
        function insertMathFormula() {
            const range = quill.getSelection(true);
            const latex = prompt('LaTeX 수식을 입력하세요:', 'E = mc^2');
            
            if (latex) {
                quill.deleteText(range.index, range.length);
                quill.insertEmbed(range.index, 'mathjax', latex, Quill.sources.USER);
                quill.insertText(range.index + 1, ' ', Quill.sources.SILENT);
                quill.setSelection(range.index + 2);
            }
        }
        
        function openChemModal() {
            if (!chemReady) {
                alert('ChemDoodle이 로드되지 않았습니다.');
                return;
            }
            
            const modal = document.getElementById('chemModal');
            const container = document.getElementById('chemSketcher');
            
            // Initialize ChemDoodle Sketcher
            if (!chemSketcher) {
                chemSketcher = new ChemDoodle.SketcherCanvas('chemSketcher', 580, 300);
                chemSketcher.styles.backgroundColor = 'white';
            }
            
            modal.style.display = 'block';
        }
        
        function closeChemModal() {
            document.getElementById('chemModal').style.display = 'none';
        }
        
        function insertChemStructure() {
            if (!chemSketcher) return;
            
            const molecule = chemSketcher.getMolecule();
            if (molecule && molecule.atoms.length > 0) {
                // Convert to SMILES
                ChemDoodle.iChemLabs.writeSMILES([molecule], [], {}, function(smiles) {
                    if (smiles) {
                        const range = quill.getSelection(true);
                        quill.deleteText(range.index, range.length);
                        quill.insertEmbed(range.index, 'chem', smiles, Quill.sources.USER);
                        quill.insertText(range.index + 1, ' ', Quill.sources.SILENT);
                        quill.setSelection(range.index + 2);
                    }
                });
            }
            
            closeChemModal();
        }
        
        // Network Status
        function checkNetworkStatus() {
            fetch(`${API_BASE}/questions/admin/questions?page=1&page_size=1`)
                .then(response => {
                    networkOnline = response.ok;
                    document.getElementById('networkStatus').innerHTML = 
                        networkOnline ? '<span class="status-ok">online</span>' : '<span class="status-fail">offline</span>';
                })
                .catch(() => {
                    networkOnline = false;
                    document.getElementById('networkStatus').innerHTML = '<span class="status-fail">offline</span>';
                });
        }
        
        // API Functions
        async function fetchWithTimeout(url, options = {}, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal,
                    mode: 'cors'
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }
        
        async function searchByOriginalId() {
            const originalId = document.getElementById('searchInput').value.trim();
            if (!originalId) return;
            
            try {
                console.log('[SEARCH] 검색 시작, ID:', originalId);
                const response = await fetchWithTimeout(
                    `${API_BASE}/questions/admin/questions?original_id=${originalId}`
                );
                
                console.log('[SEARCH] Response status:', response.status);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                console.log('[SEARCH] API 응답:', data);
                console.log('[SEARCH] 데이터 타입:', typeof data, '배열인가?', Array.isArray(data));
                
                // API 응답이 배열인 경우 (mock API)
                if (Array.isArray(data) && data.length > 0) {
                    console.log('[SEARCH] 배열 응답 처리, 첫 번째 항목:', data[0]);
                    loadQuestionDetail(data[0].id);
                }
                // API 응답이 객체이고 questions 배열을 가진 경우
                else if (data.questions && data.questions.length > 0) {
                    console.log('[SEARCH] 객체 응답 처리, questions:', data.questions);
                    loadQuestionDetail(data.questions[0].id);
                } else {
                    console.log('[SEARCH] 검색 결과 없음');
                    alert('검색 결과가 없습니다.');
                }
            } catch (error) {
                console.error('[SEARCH] 검색 실패:', error);
                alert('검색 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        async function searchRangeList() {
            const originalId = document.getElementById('searchInput').value.trim();
            const count = document.getElementById('rangeCount').value;
            
            if (!originalId) return;
            
            try {
                const endId = count ? parseInt(originalId) + parseInt(count) - 1 : originalId;
                const promises = [];
                
                for (let id = parseInt(originalId); id <= endId; id++) {
                    promises.push(
                        fetchWithTimeout(`${API_BASE}/questions/admin/questions?original_id=${id}`)
                            .then(response => response.ok ? response.json() : null)
                            .catch(() => null)
                    );
                }
                
                const results = await Promise.all(promises);
                console.log('[LIST] API 응답들:', results);
                
                // 배열 응답과 객체 응답 모두 처리
                const validResults = results.filter(r => {
                    if (!r) return false;
                    // 배열인 경우
                    if (Array.isArray(r) && r.length > 0) return true;
                    // 객체이고 questions 배열을 가진 경우
                    if (r.questions && r.questions.length > 0) return true;
                    return false;
                });
                
                const questions = validResults.map(r => {
                    // 배열인 경우 첫 번째 요소
                    if (Array.isArray(r)) return r[0];
                    // 객체인 경우 questions 배열의 첫 번째 요소
                    return r.questions[0];
                });
                
                renderList(questions);
            } catch (error) {
                console.error('[LIST] 목록 로드 실패:', error);
                alert('목록 로드 중 오류가 발생했습니다.');
            }
        }
        
        async function loadQuestionDetail(id) {
            try {
                const response = await fetchWithTimeout(`${API_BASE}/questions/${id}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                currentData = data;
                renderQuestionDetail(data);
                loadEditorContent(data);
            } catch (error) {
                console.error('[LOAD] 상세 로드 실패:', error);
                alert('문제 로드 중 오류가 발생했습니다.');
            }
        }
        
        function renderList(questions) {
            const container = document.getElementById('listContainer');
            container.innerHTML = questions.map(q => `
                <div class="list-item" onclick="loadQuestionDetail(${q.id})">
                    <strong>${q.que_en_title || 'Untitled'}</strong><br>
                    <small>ID: ${q.id} | Class: ${q.que_class || 'N/A'}</small>
                </div>
            `).join('');
        }
        
        function renderQuestionDetail(data) {
            document.getElementById('questionTitle').textContent = data.que_en_title || 'Question';
            
            const viewContent = document.getElementById('viewContent');
            viewContent.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <div class="section-header">
                        <h4 class="section-title">문제 정보</h4>
                    </div>
                    <p><strong>ID:</strong> ${data.id}</p>
                    <p><strong>Original ID:</strong> ${data.que_id}</p>
                    <p><strong>제목:</strong> ${data.que_en_title || 'N/A'}</p>
                    <p><strong>과목:</strong> ${data.que_class || 'N/A'}</p>
                    <p><strong>학년:</strong> ${data.que_grade || 'N/A'}</p>
                    <p><strong>난이도:</strong> ${data.que_level || 'N/A'}</p>
                </div>
                <div style="margin-bottom: 1rem;">
                    <div class="section-header">
                        <h4 class="section-title">문제</h4>
                        <div class="section-actions">
                            <button onclick="editInline('question')">편집</button>
                        </div>
                    </div>
                    <div class="editable-content" id="questionContent" onclick="startInlineEdit('question')">
                        <div class="edit-indicator">✏️ 클릭하여 편집</div>
                        ${renderField(data.question_en)}
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <div class="section-header">
                        <h4 class="section-title">해설</h4>
                        <div class="section-actions">
                            <button onclick="editInline('solution')">편집</button>
                        </div>
                    </div>
                    <div class="editable-content" id="solutionContent" onclick="startInlineEdit('solution')">
                        <div class="edit-indicator">✏️ 클릭하여 편집</div>
                        ${renderField(data.solution_en)}
                    </div>
                </div>
                ${data.hint_en ? `
                <div style="margin-bottom: 1rem;">
                    <div class="section-header">
                        <h4 class="section-title">힌트</h4>
                        <div class="section-actions">
                            <button onclick="editInline('hint')">편집</button>
                        </div>
                    </div>
                    <div class="editable-content" id="hintContent" onclick="startInlineEdit('hint')">
                        <div class="edit-indicator">✏️ 클릭하여 편집</div>
                        ${renderField(data.hint_en)}
                    </div>
                </div>
                ` : ''}
            `;
            
            // Render MathJax in view content
            if (mathjaxReady) {
                MathJax.typesetPromise([viewContent]);
            }
        }
        
        function renderField(content) {
            if (!content) return '<em>내용이 없습니다.</em>';
            
            // Process images
            let processedContent = content.replace(/\[이미지:\s*([^\]]+)\]/g, (match, imageName) => {
                return `<img src="${IMG_BASE}${imageName}" alt="${imageName}" style="max-width: 100%; height: auto; border: 1px solid var(--border-color); border-radius: 5px;">`;
            });
            
            return processedContent;
        }
        
        function loadEditorContent(data) {
            if (!quill) return;
            
            const content = data.question_en || '';
            quill.setContents([]);
            quill.pasteHTML(content);
            originalContent = quill.getContents();
        }
        
        function updatePreview() {
            if (!quill) return;
            
            const content = quill.root.innerHTML;
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = content;
            
            // Re-render MathJax in preview
            if (mathjaxReady) {
                MathJax.typesetPromise([previewContent]);
            }
        }
        
        async function saveCurrent() {
            if (!currentData || !quill) return;
            
            try {
                const content = quill.root.innerHTML;
                const updateData = {
                    ...currentData,
                    question_en: content
                };
                
                const response = await fetchWithTimeout(`${API_BASE}/questions/${currentData.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    alert('저장되었습니다.');
                    originalContent = quill.getContents();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('[SAVE] 저장 실패:', error);
                alert('저장 중 오류가 발생했습니다.');
            }
        }
        
        function resetEditor() {
            if (quill && originalContent) {
                quill.setContents(originalContent);
            }
        }
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Update content based on tab
            if (tabName === 'raw' && currentData) {
                document.getElementById('rawContent').textContent = JSON.stringify(currentData, null, 2);
            }
        }
        
        function loadInitialData() {
            // Load initial question if search input has value
            const searchInput = document.getElementById('searchInput');
            if (searchInput.value) {
                searchByOriginalId();
            }
        }
        
        // Inline Editing Functions
        let currentEditingField = null;
        let inlineEditor = null;
        
        function startInlineEdit(fieldType) {
            if (currentEditingField === fieldType) return;
            
            const contentElement = document.getElementById(fieldType + 'Content');
            if (!contentElement) return;
            
            // Create inline editor
            const editorContainer = document.createElement('div');
            editorContainer.className = 'editor-container';
            editorContainer.style.height = '300px';
            editorContainer.style.marginTop = '0.5rem';
            
            // Initialize Quill for inline editing
            inlineEditor = new Quill(editorContainer, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'header': [1, 2, 3, false] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['blockquote', 'code-block'],
                        ['link', 'image'],
                        ['formula', 'chem'],
                        ['clean']
                    ]
                }
            });
            
            // Register custom blots for inline editor
            registerCustomBlots();
            const toolbar = inlineEditor.getModule('toolbar');
            
            // Add custom buttons to inline editor toolbar
            const formulaButton = document.createElement('button');
            formulaButton.innerHTML = 'fx';
            formulaButton.title = '수식 삽입';
            formulaButton.onclick = insertMathFormula;
            
            const chemButton = document.createElement('button');
            chemButton.innerHTML = '🧪';
            chemButton.title = '화학 구조 삽입';
            chemButton.onclick = openChemModal;
            
            // Insert custom buttons into inline editor toolbar
            const toolbarContainer = inlineEditor.container.querySelector('.ql-toolbar');
            if (toolbarContainer) {
                const cleanButton = toolbarContainer.querySelector('.ql-clean');
                if (cleanButton) {
                    cleanButton.parentNode.insertBefore(formulaButton, cleanButton);
                    cleanButton.parentNode.insertBefore(chemButton, cleanButton);
                } else {
                    toolbarContainer.appendChild(formulaButton);
                    toolbarContainer.appendChild(chemButton);
                }
            }
            
            // Set content
            const currentContent = currentData[fieldType + '_en'] || '';
            inlineEditor.pasteHTML(currentContent);
            
            // Replace content
            contentElement.innerHTML = '';
            contentElement.appendChild(editorContainer);
            contentElement.classList.add('editing');
            
            // Add save/cancel buttons
            const buttonContainer = document.createElement('div');
            buttonContainer.style.marginTop = '0.5rem';
            buttonContainer.innerHTML = `
                <button onclick="saveInlineEdit('${fieldType}')">저장</button>
                <button onclick="cancelInlineEdit('${fieldType}')">취소</button>
            `;
            contentElement.appendChild(buttonContainer);
            
            currentEditingField = fieldType;
        }
        
        function saveInlineEdit(fieldType) {
            if (!inlineEditor || !currentData) return;
            
            const content = inlineEditor.root.innerHTML;
            currentData[fieldType + '_en'] = content;
            
            // Update the display
            const contentElement = document.getElementById(fieldType + 'Content');
            contentElement.innerHTML = `
                <div class="edit-indicator">✏️ 클릭하여 편집</div>
                ${renderField(content)}
            `;
            contentElement.classList.remove('editing');
            
            // Re-render MathJax
            if (mathjaxReady) {
                MathJax.typesetPromise([contentElement]);
            }
            
            currentEditingField = null;
            inlineEditor = null;
        }
        
        function cancelInlineEdit(fieldType) {
            const contentElement = document.getElementById(fieldType + 'Content');
            const originalContent = currentData[fieldType + '_en'] || '';
            
            contentElement.innerHTML = `
                <div class="edit-indicator">✏️ 클릭하여 편집</div>
                ${renderField(originalContent)}
            `;
            contentElement.classList.remove('editing');
            
            // Re-render MathJax
            if (mathjaxReady) {
                MathJax.typesetPromise([contentElement]);
            }
            
            currentEditingField = null;
            inlineEditor = null;
        }
        
        function editInline(fieldType) {
            startInlineEdit(fieldType);
        }
        
        // Resizable Panels
        function initResizablePanels() {
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const resizeHandle = document.getElementById('resizeHandle');
            
            let isResizing = false;
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const containerWidth = document.querySelector('.container').offsetWidth;
                const newLeftWidth = e.clientX;
                const minWidth = 250;
                const maxWidth = containerWidth - 250;
                
                if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
                    leftPanel.style.width = newLeftWidth + 'px';
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }
        
        // Event Listeners
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchByOriginalId();
            }
        });
        
        // Close modal when clicking outside
        document.getElementById('chemModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeChemModal();
            }
        });
        
        // Initialize resizable panels
        document.addEventListener('DOMContentLoaded', function() {
            initResizablePanels();
        });
    </script>
</body>
</html>
