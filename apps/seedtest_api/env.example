# SeedTest API - Local Development Environment Configuration
# Copy this file to .env and adjust values for your setup

# ===== Core Settings =====
APP_ENV=local
API_PREFIX=/api/seedtest

# ===== Database =====
# PostgreSQL connection string (SQLAlchemy format)
DATABASE_URL=postgresql+psycopg2://user:pass@localhost:5432/dreamseed_db
# Example for local Docker: postgresql+psycopg2://user:pass@127.0.0.1:5432/dreamseed_db

# ===== Authentication (JWT) =====
# Option 1: JWKS URL (recommended for production)
JWKS_URL=https://auth.dreamseedai.com/.well-known/jwks.json
JWT_ISS=https://auth.dreamseedai.com/
JWT_AUD=seedtest-api

# Option 2: Direct public key (PEM format, multiline OK)
# JWT_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----"

# Local dev: skip JWT verification (WARNING: dev only!)
LOCAL_DEV=true

# ===== CAT (Computerized Adaptive Testing) Parameters =====
# Prior distribution
CAT_PRIOR_MEAN=0.0
CAT_PRIOR_SD=1.0

# Bayesian update constraints
CAT_STEP_CAP=1.0

# Selection criterion: FISHER (default) or KL
CAT_CRITERION=FISHER
CAT_KL_DELTA=0.5

# Selection policy
CAT_TOP_N=3                    # Randomesque top-N items
CAT_AVOID_REPEAT_K=2          # Avoid same topic for last K items
CAT_REPEAT_PENALTY=0.15       # 15% penalty for topic repetition
# CAT_BLUEPRINT={"1": 0.3, "2": 0.4, "3": 0.3}  # JSON: topic_id -> proportion
# CAT_MAX_EXPOSURE=50          # Max times an item can be selected

# Stopping rules
CAT_MODE=VARIABLE             # VARIABLE or FIXED
CAT_SEM_THRESHOLD=0.3         # Stop when SE < threshold (variable mode)
CAT_MIN_ITEMS=10              # Minimum items before SE stop allowed
CAT_MAX_ITEMS=30              # Hard cap on total items
CAT_MAX_TIME_SECONDS=1800     # 30 minutes

# Starting item randomization
CAT_START_RANDOMIZED=true
CAT_START_BAND_WIDTH=0.5      # +/- around theta0
CAT_START_TOP_N=3

# Content balancing
CAT_AVOID_SAME_TOPIC_HARD=true
CAT_SAME_TOPIC_TOLERANCE=0.05

# ===== Item Bank Filters =====
# Filter by subject, difficulty range, org, topics, tags
# BANK_SUBJECT=mathematics
# BANK_DIFF_MIN=-2.0
# BANK_DIFF_MAX=2.0
# BANK_ORG_ID=1
# BANK_TOPIC_IDS=1,2,3,5      # Comma-separated topic IDs
# BANK_TAGS=algebra,geometry  # Comma-separated tags

# Subsampling (optional)
# BANK_SAMPLE_K=100           # Sample K items
# BANK_SAMPLE_P=0.5           # Sample 50% of items

# Tags re-detection TTL (seconds, 0=always re-detect)
TAGS_KIND_TTL_SEC=300

# ===== Monitoring & Logging =====
# Sentry (optional)
# SENTRY_DSN=https://...@sentry.io/...
# SENTRY_ENV=local
# SENTRY_TRACES_SAMPLE_RATE=0.0
# SENTRY_PROFILES_SAMPLE_RATE=0.0

# Exposure logging path (optional)
# CAT_EXPOSURE_LOG_PATH=/tmp/cat_exposure.jsonl

# ===== Caching (optional) =====
# When set, Redis is used for shared caching (topics, etc.); otherwise in-process TTL cache is used.
# Example connection string: redis://127.0.0.1:6379/0
# REDIS_URL=redis://127.0.0.1:6379/0
# Namespace prefix for keys
# REDIS_KEY_PREFIX=seedtest:

# ===== Testing =====
# Enable integration tests (requires Docker Compose for DB)
RUN_INTEGRATION_TESTS=0       # Set to 1 to run integration tests locally

# ===== R Plumber Microservice (optional) =====
# Base URL for internal ClusterIP Service or local dev instance.
# Example (K8s internal): http://r-glmm-plumber.seedtest.svc.cluster.local
# Example (local): http://127.0.0.1:8000
# R_PLUMBER_BASE_URL=http://127.0.0.1:8000

# Optional shared-secret for simple internal auth; sent as X-Internal-Token
# R_PLUMBER_INTERNAL_TOKEN=change_me

# HTTP timeout in seconds
# R_PLUMBER_TIMEOUT_SECS=15

# ===== Legacy MPC Read-only Adapter (serve real data without schema migration) =====
# Toggle to read questions from legacy sources on GET (list/detail) only.
# Writes (POST/PUT/DELETE) still go to SeedTest datastore.
# Enable one of the modes below (HTTP or PostgreSQL). If both are set, PostgreSQL takes precedence.

# Mode A: HTTP bridge (provide URL templates)
# USE_MPC_LEGACY_READONLY=true
# MPC_HTTP_LIST_URL=https://mpcstudy.com/api/questions?query={q}&page={page}&limit={limit}
# MPC_HTTP_DETAIL_URL=https://mpcstudy.com/api/questions/{id}
# MPC_HTTP_TIMEOUT_SECS=6

# Mode B: PostgreSQL direct read (recommended when you imported mpcstudy_db.sql locally)
# NOTE: URL-encode special chars in password, e.g., '@' => '%40'
# USE_MPC_LEGACY_READONLY=true
# MPC_PG_URL=postgresql+psycopg2://postgres:DreamSeedAi%400908@127.0.0.1:5432/dreamseed
# MPC_PG_LIST_SQL=\
# SELECT\
#   q.id,\
#   q.question AS content,\
#   q.topic_name AS topic,\
#   q.difficulty_score AS difficulty,\
#   q.updated_at,\
#   q.created_at,\
#   q.options_json AS options,\
#   q.answer_index AS answer\
# FROM mpcstudy.tbl_question q\
# WHERE (:q = '' OR LOWER(q.question) LIKE LOWER('%' || :q || '%'))\
# ORDER BY q.updated_at DESC\
# LIMIT :limit OFFSET (:page - 1) * :limit;
# MPC_PG_DETAIL_SQL=\
# SELECT\
#   q.id,\
#   q.question AS content,\
#   q.topic_name AS topic,\
#   q.difficulty_score AS difficulty,\
#   q.updated_at,\
#   q.created_at,\
#   q.options_json AS options,\
#   q.answer_index AS answer\
# FROM mpcstudy.tbl_question q\
# WHERE q.id = :id\
# LIMIT 1;

# Mode C: MySQL direct read (native legacy DB)
# Requires: pip install -r apps/seedtest_api/requirements.txt (PyMySQL)
# USE_MPC_LEGACY_READONLY=true
# Example DSN: mysql+pymysql://mpcstudy_root:yourpass@127.0.0.1:3306/mpcstudy_db?charset=utf8mb4
# MPC_MYSQL_URL=mysql+pymysql://mpcstudy_root:password@127.0.0.1:3306/mpcstudy_db?charset=utf8mb4
# NOTE: If password contains special characters, URL-encode them (e.g., @ => %40)
# Example SQL templates (adjust column/table names to your schema):
# MPC_MYSQL_LIST_SQL=\
# SELECT\
#   q.id,\
#   q.que_content AS content,\
#   q.que_class,\
#   q.que_grade,\
#   q.que_level,\
#   q.options_raw,\
#   q.answer_char,\
#   q.created_at,\
#   q.updated_at\
# FROM mpcstudy_db.tbl_question q\
# WHERE (:q = '' OR LOWER(q.que_content) LIKE LOWER(CONCAT('%', :q, '%')))\
# ORDER BY q.updated_at DESC\
# LIMIT :limit OFFSET :offset;
# MPC_MYSQL_DETAIL_SQL=\
# SELECT\
#   q.id,\
#   q.que_content AS content,\
#   q.que_class,\
#   q.que_grade,\
#   q.que_level,\
#   q.options_raw,\
#   q.answer_char,\
#   q.created_at,\
#   q.updated_at\
# FROM mpcstudy_db.tbl_question q\
# WHERE q.id = :id\
# LIMIT 1;

