---
title: "Weekly Learning Report"
author: "DreamSeed AI"
output-file: index
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 2
    number-sections: true
    embed-resources: true
    self-contained: true
    fig-width: 8
    fig-height: 6
    code-fold: true
date: today
execute:
  echo: false
  warning: false
  message: false
params:
  data_file: "_data.json"
---

```{r setup}
#| include: false
library(jsonlite)
library(dplyr)
library(ggplot2)
library(tidyr)
library(lubridate)

# Load data from JSON
data <- fromJSON(params$data_file)

user_id <- data$user_id
week_start <- as.Date(data$week_start)
week_end <- week_start + days(6)
kpis <- data$kpis
ability_trend <- data$ability_trend
goals <- data$goals
topic_features <- data$topic_features
```

# Summary for Week of `r week_start`

**Student ID**: `r user_id`  
**Report Period**: `r week_start` to `r week_end`  
**Generated**: `r Sys.Date()`

---

## Weekly Performance Metrics

```{r kpis-table}
# Display KPIs as a table
kpi_df <- data.frame(
  Metric = c("Interest (I_t)", "Engagement (E_t)", "Responsiveness (R_t)", 
             "Adherence (A_t)", "Performance (P)", "Strength (S)"),
  Value = c(
    ifelse(!is.null(kpis$I_t), round(kpis$I_t, 2), NA),
    ifelse(!is.null(kpis$E_t), round(kpis$E_t, 2), NA),
    ifelse(!is.null(kpis$R_t), round(kpis$R_t, 2), NA),
    ifelse(!is.null(kpis$A_t), round(kpis$A_t, 2), NA),
    ifelse(!is.null(kpis$P), round(kpis$P, 2), NA),
    ifelse(!is.null(kpis$S), round(kpis$S, 2), NA)
  ),
  Description = c(
    "Interest level (0-1)",
    "Engagement rate (0-1)",
    "Session responsiveness (0-1)",
    "Goal adherence (0-1)",
    "Overall performance (0-1)",
    "Learning strength (0-1)"
  )
)

knitr::kable(kpi_df, caption = "Weekly Key Performance Indicators")
```

### KPI Visualization

```{r kpis-chart}
#| fig-cap: "Weekly KPIs Radar Chart"
#| fig-width: 6
#| fig-height: 6

if (!all(is.na(kpi_df$Value))) {
  # Radar chart using ggplot2
  kpi_radar <- kpi_df %>%
    filter(!is.na(Value)) %>%
    mutate(
      Metric = factor(Metric, levels = Metric),
      Value = pmax(0, pmin(1, Value))
    )
  
  ggplot(kpi_radar, aes(x = Metric, y = Value, group = 1)) +
    geom_polygon(fill = "steelblue", alpha = 0.3, color = "steelblue", size = 1) +
    geom_point(color = "steelblue", size = 3) +
    coord_polar() +
    ylim(0, 1) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(size = 10),
      axis.title = element_blank()
    ) +
    labs(title = "Weekly Performance Profile")
} else {
  cat("No KPI data available for this week.\n")
}
```

---

## Ability (θ) Trend

```{r ability-trend}
#| fig-cap: "IRT Ability (θ) Trend Over Time"
#| fig-width: 8
#| fig-height: 5

if (!is.null(ability_trend) && length(ability_trend) > 0) {
  ability_df <- bind_rows(ability_trend) %>%
    filter(!is.na(theta)) %>%
    mutate(date = as.Date(date)) %>%
    arrange(date)
  
  if (nrow(ability_df) > 0) {
    ggplot(ability_df, aes(x = date, y = theta)) +
      geom_line(color = "darkgreen", size = 1) +
      geom_point(color = "darkgreen", size = 2) +
      geom_ribbon(
        aes(ymin = theta - se, ymax = theta + se),
        alpha = 0.2,
        fill = "darkgreen"
      ) +
      theme_minimal() +
      labs(
        title = "Ability Trend (θ)",
        subtitle = "Higher values indicate stronger ability",
        x = "Date",
        y = "Ability (θ)"
      ) +
      theme(
        plot.title = element_text(size = 14, face = "bold"),
        axis.text = element_text(size = 10)
      )
  } else {
    cat("No ability trend data available.\n")
  }
} else {
  cat("No ability trend data available.\n")
}
```

**Interpretation**:  
- **θ (theta)** represents your estimated ability level on the IRT scale.
- A positive value indicates above-average ability; negative indicates below-average.
- The shaded region shows the uncertainty (standard error) of the estimate.

### Weekly Accuracy Trend (Bayesian Growth Model Input)

```{r accuracy-trend}
#| fig-cap: "Weekly Accuracy Trend (Z-Score)"
#| fig-width: 8
#| fig-height: 5

# If accuracy trend is available (from brms fitting)
if (!is.null(data$accuracy_trend) && length(data$accuracy_trend) > 0) {
  acc_df <- bind_rows(data$accuracy_trend) %>%
    filter(!is.na(accuracy_zscore)) %>%
    mutate(week = as.Date(week)) %>%
    arrange(week)
  
  if (nrow(acc_df) > 0) {
    ggplot(acc_df, aes(x = week, y = accuracy_zscore)) +
      geom_line(color = "coral", size = 1) +
      geom_point(color = "coral", size = 2) +
      geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
      theme_minimal() +
      labs(
        title = "Weekly Accuracy Trend (Standardized)",
        subtitle = "Z-score: deviation from cohort mean accuracy",
        x = "Week",
        y = "Accuracy Z-Score"
      ) +
      theme(
        plot.title = element_text(size = 14, face = "bold"),
        axis.text = element_text(size = 10)
      )
  } else {
    cat("No weekly accuracy trend data available.\n")
  }
} else {
  cat("Weekly accuracy trend not yet available (requires Bayesian growth model fitting).\n")
}
```

**Note**: The Bayesian growth model uses weekly accuracy (standardized as z-scores) to estimate growth trajectories and predict future performance with uncertainty quantification.

---

## IRT Linking / Equating (if available)

```{r linking-constants}
# Show linking/equating constants if provided by the latest calibration
if (!is.null(data$linking_constants) && length(data$linking_constants) > 0) {
  lc <- data$linking_constants
  lc_df <- data.frame(
    Name = names(lc),
    Value = unlist(lc),
    row.names = NULL
  )
  # Move run identifiers (prefixed with _) to caption
  run_id <- ifelse(!is.null(lc$`_run_id`), as.character(lc$`_run_id`), NA)
  fitted_at <- ifelse(!is.null(lc$`_fitted_at`), as.character(lc$`_fitted_at`), NA)
  lc_df <- lc_df[!grepl("^_", lc_df$Name), ]
  if (nrow(lc_df) > 0) {
    cap <- "Linking/Equating Constants"
    if (!is.na(run_id) || !is.na(fitted_at)) {
      cap <- paste0(cap, " (run=", ifelse(!is.na(run_id), run_id, "-"), ", fitted_at=", ifelse(!is.na(fitted_at), fitted_at, "-"), ")")
    }
    knitr::kable(lc_df, caption = cap)
  } else {
    cat("Linking constants metadata present, but no numeric entries to display.\n")
  }
} else {
  cat("No linking/equating constants available for this period.\n")
}
```

---

## Bayesian Growth & Uncertainty

```{r bayesian-posterior}
#| fig-cap: "Goal Attainment Probability with 95% Credible Interval"
#| fig-width: 8
#| fig-height: 5

# Check if Bayesian posterior data is available
if (!is.null(data$bayesian_growth) && length(data$bayesian_growth) > 0) {
  bp <- data$bayesian_growth
  
  # Extract P (goal probability), sigma (uncertainty), CI bounds
  P <- if (!is.null(bp$P)) bp$P else if (!is.null(kpis$P)) kpis$P else NA
  sigma <- if (!is.null(bp$sigma)) bp$sigma else NA
  P_lower <- if (!is.null(bp$P_lower)) bp$P_lower else NA
  P_upper <- if (!is.null(bp$P_upper)) bp$P_upper else NA
  
  if (!is.na(P)) {
    # Gauge chart showing P with CI
    library(ggplot2)
    gauge_df <- data.frame(
      Metric = "Goal Probability",
      Value = P,
      Lower = if (!is.na(P_lower)) P_lower else max(0, P - 1.96 * ifelse(!is.na(sigma), sigma, 0.1)),
      Upper = if (!is.na(P_upper)) P_upper else min(1, P + 1.96 * ifelse(!is.na(sigma), sigma, 0.1))
    )
    
    ggplot(gauge_df, aes(x = Metric, y = Value)) +
      geom_bar(stat = "identity", fill = "steelblue", width = 0.3) +
      geom_errorbar(
        aes(ymin = Lower, ymax = Upper),
        width = 0.1,
        color = "darkblue",
        size = 1
      ) +
      ylim(0, 1) +
      coord_flip() +
      theme_minimal() +
      labs(
        title = "Goal Attainment Probability (P)",
        subtitle = paste0(
          "P = ", round(P, 3), 
          " [", round(gauge_df$Lower, 3), ", ", round(gauge_df$Upper, 3), "]",
          if (!is.na(sigma)) paste0(" (σ = ", round(sigma, 3), ")") else ""
        ),
        x = NULL,
        y = "Probability"
      ) +
      theme(
        plot.title = element_text(size = 14, face = "bold"),
        plot.subtitle = element_text(size = 11, color = "gray40"),
        axis.text = element_text(size = 10)
      )
  } else {
    cat("Bayesian P value not available.\n")
  }
} else if (!is.null(kpis$P)) {
  # Fallback: show gauge from KPIs if detailed posterior not provided
  P <- kpis$P; sigma <- if (!is.null(kpis$sigma)) kpis$sigma else NA
  gauge_df <- data.frame(Metric = "Goal Probability", Value = P,
                         Lower = max(0, P - 1.96 * ifelse(!is.na(sigma), sigma, 0.1)),
                         Upper = min(1, P + 1.96 * ifelse(!is.na(sigma), sigma, 0.1)))
  ggplot(gauge_df, aes(x = Metric, y = Value)) +
    geom_bar(stat = "identity", fill = "steelblue", width = 0.3) +
    geom_errorbar(aes(ymin = Lower, ymax = Upper), width = 0.1, color = "darkblue", size = 1) +
    ylim(0, 1) + coord_flip() + theme_minimal() +
    labs(title = "Goal Attainment Probability (P)", x = NULL, y = "Probability")
} else {
  cat("No Bayesian data available for this week.\n")
}
```

**Interpretation**:  
- **P (Goal Probability)**: Estimated probability of achieving your learning goal, derived from Bayesian hierarchical modeling (brms).
- **95% Credible Interval** (error bars): The range where we are 95% confident the true probability lies.
- **σ (Uncertainty)**: Standard deviation of the posterior distribution. Lower σ indicates more confidence in the estimate.

### Bayesian vs Frequentist Uncertainty

The Bayesian approach provides:
- **Credible intervals** instead of confidence intervals
- **Full posterior distribution** capturing all parameter uncertainty
- **Direct probabilistic interpretation**: "There is a 95% probability that P is within [lower, upper]"

---

## Prophet Forecast (I_t) with Uncertainty

```{r prophet-forecast}
#| fig-cap: "Prophet Forecast with 80%/95% Intervals"
#| fig-width: 8
#| fig-height: 5

if (!is.null(data$prophet_forecast) && length(data$prophet_forecast) > 0) {
  pf <- data$prophet_forecast
  fc <- pf$forecast_data
  if (!is.null(fc) && length(fc) > 0) {
    fc_df <- bind_rows(fc) %>% mutate(ds = as.Date(ds))
    ggplot(fc_df, aes(x = ds, y = yhat)) +
      geom_ribbon(aes(ymin = yhat_lower, ymax = yhat_upper), fill = "lightblue", alpha = 0.3) +
      geom_line(color = "blue", size = 1) +
      theme_minimal() +
      labs(title = "Short-term I_t Forecast", x = "Date", y = "Predicted I_t")
  } else {
    cat("No forecast data available.\n")
  }

  if (!is.null(pf$anomalies) && length(pf$anomalies) > 0) {
    an_df <- bind_rows(pf$anomalies)
    knitr::kable(an_df, caption = "Recent Anomalies (Absolute z-score exceeds threshold)")
  }
} else {
  cat("Prophet forecast not available.\n")
}
```

---

## Survival Risk Summary

```{r survival-risk}
sr <- data$survival_risk
if (!is.null(sr)) {
  risk <- ifelse(!is.null(sr$churn_risk), round(sr$churn_risk, 3), NA)
  cat(paste0("Estimated 14-day churn risk: ", ifelse(is.na(risk), "N/A", risk), "\n"))
  if (!is.null(sr$fit_meta)) {
    fm <- sr$fit_meta
    if (!is.null(fm$hazard_ratios)) {
      hr_df <- data.frame(
        Covariate = names(fm$hazard_ratios),
        HazardRatio = unlist(fm$hazard_ratios)
      )
      knitr::kable(hr_df, caption = "Survival Model Hazard Ratios")
    }
  }
} else {
  cat("Survival risk data not available.\n")
}
```

---

## Segment Snapshot

```{r segment-snapshot}
seg <- data$user_segment
if (!is.null(seg)) {
  cat(paste0("Current Segment: ", seg$segment_label, "\n"))
  if (!is.null(seg$features_snapshot)) {
    fs <- seg$features_snapshot
    fs_df <- data.frame(Feature = names(fs), Value = unlist(fs))
    knitr::kable(fs_df, caption = "Segment Feature Snapshot")
  }
} else {
  cat("No segment assignment available.\n")
}
```

## Learning Goals

```{r goals-table}
if (!is.null(goals) && length(goals) > 0) {
  goals_df <- bind_rows(goals) %>%
    mutate(
      interest = ifelse(!is.na(interest), paste0(interest, "/5"), "N/A"),
      target_score = ifelse(!is.na(target_score), target_score, "N/A"),
      target_date = ifelse(!is.na(target_date), as.character(target_date), "N/A")
    ) %>%
    select(subject_id, interest, target_score, target_date)
  
  knitr::kable(goals_df, 
               col.names = c("Subject ID", "Interest Level", "Target Score", "Target Date"),
               caption = "Your Learning Goals")
} else {
  cat("No learning goals set for this period.\n")
}
```

---

## Topic-Level Performance

```{r topic-performance}
#| fig-cap: "Topic-Level Performance: Accuracy by Topic"
#| fig-width: 8
#| fig-height: 6

if (!is.null(topic_features) && length(topic_features) > 0) {
  topic_df <- bind_rows(topic_features) %>%
    filter(!is.na(attempts), attempts > 0) %>%
    mutate(
      date = as.Date(date),
      accuracy = ifelse(attempts > 0, correct / attempts, NA)
    )
  
  if (nrow(topic_df) > 0) {
    # Aggregate by topic
    topic_summary <- topic_df %>%
      group_by(topic_id) %>%
      summarise(
        total_attempts = sum(attempts, na.rm = TRUE),
        total_correct = sum(correct, na.rm = TRUE),
        avg_accuracy = mean(accuracy, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      arrange(desc(avg_accuracy))
    
    ggplot(topic_summary, aes(x = reorder(topic_id, avg_accuracy), y = avg_accuracy)) +
      geom_col(fill = "coral", alpha = 0.8) +
      coord_flip() +
      theme_minimal() +
      labs(
        title = "Topic-Level Accuracy",
        subtitle = "Average accuracy per topic",
        x = "Topic",
        y = "Accuracy (0-1)"
      ) +
      theme(
        plot.title = element_text(size = 14, face = "bold"),
        axis.text = element_text(size = 10)
      )
    
    # Print summary table
    cat("\n\n")
    knitr::kable(topic_summary, 
                 col.names = c("Topic", "Attempts", "Correct", "Accuracy"),
                 caption = "Topic Performance Summary",
                 digits = 2)
  } else {
    cat("No topic performance data available for this week.\n")
  }
} else {
  cat("No topic performance data available for this week.\n")
}
```

---

## Daily Activity

```{r daily-activity}
#| fig-cap: "Daily Activity: Number of Attempts per Day"
#| fig-width: 8
#| fig-height: 4

if (!is.null(topic_features) && length(topic_features) > 0) {
  daily_df <- bind_rows(topic_features) %>%
    filter(!is.na(date)) %>%
    mutate(date = as.Date(date)) %>%
    group_by(date) %>%
    summarise(
      total_attempts = sum(attempts, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    arrange(date)
  
  if (nrow(daily_df) > 0) {
    ggplot(daily_df, aes(x = date, y = total_attempts)) +
      geom_line(color = "purple", size = 1) +
      geom_point(color = "purple", size = 2) +
      theme_minimal() +
      labs(
        title = "Daily Activity Level",
        subtitle = "Number of attempts per day",
        x = "Date",
        y = "Attempts"
      ) +
      theme(
        plot.title = element_text(size = 14, face = "bold"),
        axis.text = element_text(size = 10)
      )
  } else {
    cat("No daily activity data available for this week.\n")
  }
} else {
  cat("No daily activity data available for this week.\n")
}
```

---

## Recommendations

Based on your performance this week:

```{r recommendations}
# Generate personalized recommendations
rec <- list()

# Low engagement
if (!is.null(kpis$E_t) && kpis$E_t < 0.5) {
  rec <- c(rec, "- **Increase engagement**: Try setting aside more time for focused practice sessions.")
}

# Low performance
if (!is.null(kpis$P) && kpis$P < 0.6) {
  rec <- c(rec, "- **Improve performance**: Consider reviewing foundational concepts before attempting harder questions.")
}

# Low adherence
if (!is.null(kpis$A_t) && kpis$A_t < 0.7) {
  rec <- c(rec, "- **Goal adherence**: Stay on track with your learning goals. Set daily reminders if needed.")
}

# Positive improvement
if (!is.null(kpis$S) && kpis$S > 0.1) {
  rec <- c(rec, "- **Great progress!**: Your learning strength has improved. Keep up the good work!")
}

if (length(rec) == 0) {
  rec <- c(rec, "- Keep up the consistent effort! Your metrics look good overall.")
}

cat(paste(rec, collapse = "\n"))
```

---

## About This Report

This report was automatically generated using the **DreamSeed AI** analytics pipeline. It includes:

- **Weekly KPIs**: Metrics derived from your learning activity, engagement, and goal attainment.
- **Ability Trend**: IRT-based ability estimates (θ) that track your progress over time.
- **Topic Performance**: Accuracy and improvement metrics for each topic you studied.
- **Recommendations**: Personalized suggestions based on your performance data.

For questions or support, please contact your instructor or visit our help center.

---

*Report generated on `r Sys.Date()`*
