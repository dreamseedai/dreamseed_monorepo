apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-main
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/part-of: kube-prometheus-stack
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m
      # Slack Webhook: 아래 receivers의 api_url_file로 주입 (보안)
      # pagerduty_url: Alertmanager 기본값 사용 (https://events.pagerduty.com/v2/enqueue)
      pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

    # ──────────────────────────────────────────────────────────────────
    # 수신자(Receivers)
    # ──────────────────────────────────────────────────────────────────
    receivers:
      - name: 'null'

      - name: 'slack-seedtest'
        slack_configs:
          - channel: '#seedtest-alerts'
            send_resolved: true
            username: 'alertmanager'
            icon_emoji: ':rotating_light:'
            title: |-
              [{{ .Status | toUpper }}] {{ .CommonLabels.service }} {{ .CommonLabels.severity }}
            text: |-
              *Summary*: {{ .CommonAnnotations.summary }}
              *Description*: {{ .CommonAnnotations.description }}
              *Labels*: `{{ .CommonLabels }}`
              *StartsAt*: {{ .StartsAt }}
              *EndsAt*: {{ .EndsAt }}
            # Slack webhook URL은 Secret 파일로 마운트 (보안)
            api_url_file: /etc/alertmanager/secrets/alertmanager-secrets/slack_webhook_url

      - name: 'pagerduty-seedtest'
        pagerduty_configs:
          # PagerDuty Routing Key는 Secret 파일로 마운트 (보안)
          - routing_key_file: /etc/alertmanager/secrets/pagerduty-routing-key/routing_key
            send_resolved: true
            severity: '{{ .CommonLabels.severity | default "error" }}'
            class: '{{ .CommonLabels.service | default "seedtest-api" }}'
            component: '{{ .CommonLabels.instance }}'
            group: '{{ .CommonLabels.namespace }}'
            source: '{{ .ExternalURL }}'
            description: '{{ .CommonAnnotations.summary }} | {{ .CommonAnnotations.description }}'

      - name: 'slack-lowprio'
        slack_configs:
          - channel: '#seedtest-notify'
            send_resolved: true
            title: '[{{ .Status | toUpper }}] {{ .CommonLabels.service }} ({{ .CommonLabels.severity }})'
            text: |-
              {{ range .Alerts }}
              *{{ .Labels.alertname }}* {{ .Labels.severity }} {{ .Labels.service }}
              {{ .Annotations.summary }}
              {{ end }}
            # Slack webhook URL은 Secret 파일로 마운트 (보안)
            api_url_file: /etc/alertmanager/secrets/alertmanager-secrets/slack_webhook_url

    # ──────────────────────────────────────────────────────────────────
    # 라우팅 트리(Routes)
    # ──────────────────────────────────────────────────────────────────
    route:
      receiver: 'null'
      group_by: ['alertname', 'service', 'namespace']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 2h

      # 공통 일시 무시(유지보수 창) – 필요 시 아래 주석 해제
      # mute_time_intervals:
      #   - maintenance-window

      routes:
        # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        # 1) seedtest-api 서비스의 Critical 알림 → PagerDuty (즉시)
        # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        - matchers:
            - 'service = seedtest-api'
            - 'severity = critical'
          receiver: 'pagerduty-seedtest'
          group_wait: 0s           # 즉시 전송
          continue: false          # 이후 route 무시

        # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        # 2) seedtest-api 서비스의 Warning/Info → Slack
        # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        - matchers:
            - 'service = seedtest-api'
            - 'severity =~ "warning|info"'
          receiver: 'slack-seedtest'
          continue: false

        # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        # 3) seedtest 네임스페이스(기타 앱) – 저우선 Slack 알림
        # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        - matchers:
            - 'namespace = seedtest'
          receiver: 'slack-lowprio'
          continue: false

    # ──────────────────────────────────────────────────────────────────
    # 억제 규칙(Inhibit Rules)
    # Critical이 활성화되면 같은 alertname의 Warning은 억제
    # ──────────────────────────────────────────────────────────────────
    inhibit_rules:
      - source_matchers: ['severity = critical']
        target_matchers: ['severity = warning']
        equal: ['alertname', 'service', 'namespace']

    # ──────────────────────────────────────────────────────────────────
    # 유지보수 창(Time Intervals) - 선택 사항
    # ──────────────────────────────────────────────────────────────────
    # time_intervals:
    #   - name: maintenance-window
    #     time_intervals:
    #       - weekdays: ['saturday', 'sunday']
    #         times:
    #           - start_time: '00:00'
    #             end_time: '08:00'
