#!/usr/bin/env bash
# Staging Alembic Migration + Smoke Test Script (SAMPLE - NO SENSITIVE VALUES)
# Usage: Copy to scripts/local/ and customize before running
set -euo pipefail

# ====== CONFIG (Required variables) ======
PROJECT="${PROJECT:-univprepai}"
NS="${NS:-seedtest}"
APP_IMAGE="${APP_IMAGE:-asia-northeast3-docker.pkg.dev/univprepai/seedtest/seedtest-api:latest}"
SECRET="${SECRET:-seedtest-db-credentials}"
CONN_NAME="${CONN_NAME:-univprepai:asia-northeast3:seedtest-staging}"
JOB_NAME="alembic-upgrade-$(date +%Y%m%d-%H%M%S)"

# ====== Prerequisites check ======
command -v kubectl >/dev/null || { echo "âŒ kubectl í•„ìš”"; exit 1; }

echo "ğŸš€ Alembic ë§ˆì´ê·¸ë ˆì´ì…˜ + ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
echo "  Namespace: $NS"
echo "  Image: $APP_IMAGE"
echo "  Job: $JOB_NAME"
echo ""

# ====== Step 1: Create Alembic Upgrade Job ======
echo "[1/4] Alembic Upgrade Job ìƒì„±..."
cat <<YAML | kubectl -n "$NS" apply -f -
apiVersion: batch/v1
kind: Job
metadata:
  name: $JOB_NAME
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: seedtest-api
      containers:
      - name: cloud-sql-proxy
        image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.11.3
        args:
          - "--structured-logs"
          - "--port=5432"
          - "$CONN_NAME"
        securityContext:
          runAsNonRoot: true
        resources:
          requests:
            cpu: "50m"
            memory: "64Mi"
      - name: migrator
        image: $APP_IMAGE
        workingDir: /app/seedtest_api
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: $SECRET
              key: DATABASE_URL
        command: ["bash","-c"]
        args:
          - |
            set -euo pipefail
            echo "Waiting for Cloud SQL Proxy..."
            sleep 5
            echo "Running Alembic upgrade..."
            PYTHONPATH=/app alembic upgrade head
            echo "Current Alembic version:"
            PYTHONPATH=/app alembic current
YAML

if [ $? -ne 0 ]; then
  echo "âŒ Job ìƒì„± ì‹¤íŒ¨"
  exit 1
fi
echo "âœ… Job ìƒì„± ì™„ë£Œ"

# ====== Step 2: Wait and monitor job ======
echo "[2/4] Job ì‹¤í–‰ ëª¨ë‹ˆí„°ë§..."
sleep 3

# Follow logs
echo "ğŸ“‹ Job ë¡œê·¸:"
kubectl -n "$NS" logs -f "job/$JOB_NAME" -c migrator 2>/dev/null || true

# Wait for completion
echo ""
echo "â³ Job ì™„ë£Œ ëŒ€ê¸° (ìµœëŒ€ 5ë¶„)..."
if ! kubectl -n "$NS" wait --for=condition=complete "job/$JOB_NAME" --timeout=300s 2>/dev/null; then
  echo "âŒ Job ì‹¤íŒ¨ ë˜ëŠ” íƒ€ì„ì•„ì›ƒ"
  echo "ğŸ“‹ Job ìƒíƒœ:"
  kubectl -n "$NS" get job "$JOB_NAME"
  echo "ğŸ“‹ Pod ë¡œê·¸:"
  kubectl -n "$NS" logs "job/$JOB_NAME" -c migrator --tail=50
  exit 1
fi
echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ"

# ====== Step 3: Runtime smoke test ======
echo "[3/4] ëŸ°íƒ€ì„ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸..."
APP=seedtest-api
POD=$(kubectl -n "$NS" get pod -l app=$APP -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")

if [ -z "$POD" ]; then
  echo "âš ï¸  Podë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ìŠ¤í‚µ."
else
  echo "  Pod: $POD"
  
  # Check DATABASE_URL
  echo -n "  - DATABASE_URL í™•ì¸: "
  if kubectl -n "$NS" exec "$POD" -c api -- sh -c 'test -n "$DATABASE_URL"' 2>/dev/null; then
    echo "âœ…"
  else
    echo "âŒ"
  fi
  
  # Check DB connection
  echo -n "  - DB ì—°ê²° í…ŒìŠ¤íŠ¸: "
  if kubectl -n "$NS" exec "$POD" -c api -- python -c "
import os, psycopg
url=os.environ['DATABASE_URL'].replace('postgresql+psycopg','postgresql')
with psycopg.connect(url) as c:
    with c.cursor() as cur:
        cur.execute('SELECT 1')
        assert cur.fetchone() == (1,)
" 2>/dev/null; then
    echo "âœ…"
  else
    echo "âŒ"
  fi
  
  # Check Alembic version
  echo -n "  - Alembic ë²„ì „: "
  ALEMBIC_VERSION=$(kubectl -n "$NS" exec "$POD" -c api -- bash -c \
    "cd /app/seedtest_api && PYTHONPATH=/app alembic current 2>/dev/null | tail -1" || echo "unknown")
  echo "$ALEMBIC_VERSION"
fi

# ====== Step 4: Summary ======
echo ""
echo "[4/4] ìµœì¢… ìƒíƒœ í™•ì¸..."
kubectl -n "$NS" get job "$JOB_NAME"
echo ""
echo "âœ… ì™„ë£Œ: ë§ˆì´ê·¸ë ˆì´ì…˜ + ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸"
echo ""
echo "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:"
echo "  1. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸: kubectl -n $NS logs -l app=seedtest-api --tail=50"
echo "  2. DB í…Œì´ë¸” í™•ì¸: kubectl -n $NS exec -it <pod> -c api -- psql \$DATABASE_URL"
echo "  3. Job ì •ë¦¬: kubectl -n $NS delete job $JOB_NAME"
