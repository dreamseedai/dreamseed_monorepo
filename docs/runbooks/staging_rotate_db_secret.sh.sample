#!/usr/bin/env bash
# Staging DB Secret Rotation Script (SAMPLE - NO SENSITIVE VALUES)
# Usage: Copy to scripts/local/ and customize before running
set -euo pipefail

# ====== CONFIG (Required variables - sample has no sensitive values) ======
PROJECT="${PROJECT:-univprepai}"
INSTANCE="${INSTANCE:-seedtest-staging}"
NS="${NS:-seedtest}"
APP="${APP:-seedtest-api}"
SECRET="${SECRET:-seedtest-db-credentials}"
DBNAME="${DBNAME:-dreamseed}"
DBUSER="${DBUSER:-seedstg}"

# ====== Input (only at runtime) ======
if [ -z "${NEWPASS:-}" ]; then
  read -s -p "ìƒˆ DB ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (32ì ì´ìƒ ê¶Œì¥): " NEWPASS
  echo
fi

# Validate password length
if [ ${#NEWPASS} -lt 16 ]; then
  echo "âŒ ì˜¤ë¥˜: ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 16ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."
  exit 1
fi

# ====== Prerequisites check ======
command -v gcloud >/dev/null || { echo "âŒ gcloud CLI í•„ìš”"; exit 1; }
command -v kubectl >/dev/null || { echo "âŒ kubectl í•„ìš”"; exit 1; }

echo "ğŸ” DB Secret íšŒì „ ì‹œì‘..."
echo "  Project: $PROJECT"
echo "  Instance: $INSTANCE"
echo "  Namespace: $NS"
echo "  App: $APP"
echo ""

# ====== Step 1: Rotate Cloud SQL password ======
echo "[1/4] Cloud SQL ë¹„ë°€ë²ˆí˜¸ íšŒì „..."
gcloud config set project "$PROJECT" >/dev/null 2>&1
if ! gcloud sql users set-password "$DBUSER" --instance="$INSTANCE" --password="$NEWPASS"; then
  echo "âŒ Cloud SQL ë¹„ë°€ë²ˆí˜¸ íšŒì „ ì‹¤íŒ¨"
  exit 1
fi
echo "âœ… Cloud SQL ë¹„ë°€ë²ˆí˜¸ íšŒì „ ì™„ë£Œ"

# ====== Step 2: Update Kubernetes Secret ======
echo "[2/4] Kubernetes Secret ê°±ì‹ ..."
if ! kubectl -n "$NS" create secret generic "$SECRET" \
  --from-literal=DATABASE_URL="postgresql+psycopg://$DBUSER:$NEWPASS@127.0.0.1:5432/$DBNAME" \
  --dry-run=client -o yaml | kubectl apply -f -; then
  echo "âŒ Secret ê°±ì‹  ì‹¤íŒ¨"
  exit 1
fi
echo "âœ… Secret ê°±ì‹  ì™„ë£Œ"

# ====== Step 3: Rollout deployment ======
echo "[3/4] ë°°í¬ ì¬ì‹œì‘..."
if ! kubectl -n "$NS" rollout restart "deploy/$APP"; then
  echo "âŒ ë°°í¬ ì¬ì‹œì‘ ì‹¤íŒ¨"
  exit 1
fi

echo "[4/4] ë¡¤ì•„ì›ƒ ìƒíƒœ í™•ì¸..."
if ! kubectl -n "$NS" rollout status "deploy/$APP" --timeout=180s; then
  echo "âŒ ë¡¤ì•„ì›ƒ ì‹¤íŒ¨"
  exit 1
fi

echo ""
echo "âœ… ì™„ë£Œ: ë¹„ë°€ë²ˆí˜¸ íšŒì „ + Secret ê°±ì‹  + ë¡¤ì•„ì›ƒ"
echo ""
echo "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:"
echo "  1. ëŸ°íƒ€ì„ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
echo "  2. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸"
echo "  3. DB ì—°ê²° í…ŒìŠ¤íŠ¸"
