apiVersion: v1
kind: ConfigMap
metadata:
  name: seedtest-api-dashboard
  namespace: seedtest
  labels:
    app: seedtest-api
    governance: enabled
    grafana_dashboard: "1"
data:
  seedtest-api-governance.json: |
    {
      "dashboard": {
        "title": "SeedTest API - Governance & Performance",
        "uid": "seedtest-api-governance",
        "tags": ["seedtest", "governance", "api"],
        "timezone": "browser",
        "schemaVersion": 27,
        "version": 1,
        "refresh": "30s",
        "time": {
          "from": "now-6h",
          "to": "now"
        },
        "panels": [
          {
            "title": "API Uptime",
            "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
            "type": "stat",
            "targets": [{
              "expr": "up{job=\"seedtest-api\"}",
              "legendFormat": "{{ instance }}"
            }],
            "options": {
              "colorMode": "background",
              "graphMode": "none",
              "textMode": "value_and_name"
            },
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"value": 0, "color": "red"},
                    {"value": 1, "color": "green"}
                  ]
                }
              }
            }
          },
          {
            "title": "Request Rate (req/s)",
            "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
            "type": "stat",
            "targets": [{
              "expr": "sum(rate(http_requests_total{job=\"seedtest-api\"}[5m]))",
              "legendFormat": "Total"
            }],
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "textMode": "value_and_name"
            }
          },
          {
            "title": "P99 Latency (s)",
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
            "type": "stat",
            "targets": [{
              "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{job=\"seedtest-api\"}[5m]))",
              "legendFormat": "P99"
            }],
            "options": {
              "colorMode": "value",
              "graphMode": "area"
            },
            "fieldConfig": {
              "defaults": {
                "unit": "s",
                "thresholds": {
                  "steps": [
                    {"value": 0, "color": "green"},
                    {"value": 1, "color": "yellow"},
                    {"value": 2, "color": "red"}
                  ]
                }
              }
            }
          },
          {
            "title": "Error Rate (%)",
            "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
            "type": "stat",
            "targets": [{
              "expr": "sum(rate(http_requests_total{job=\"seedtest-api\", status=~\"5..\"}[5m])) / sum(rate(http_requests_total{job=\"seedtest-api\"}[5m])) * 100",
              "legendFormat": "5xx"
            }],
            "options": {
              "colorMode": "background"
            },
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "thresholds": {
                  "steps": [
                    {"value": 0, "color": "green"},
                    {"value": 1, "color": "yellow"},
                    {"value": 5, "color": "red"}
                  ]
                }
              }
            }
          },
          {
            "title": "HTTP Request Rate by Endpoint",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
            "type": "timeseries",
            "targets": [{
              "expr": "sum(rate(http_requests_total{job=\"seedtest-api\"}[5m])) by (endpoint, method)",
              "legendFormat": "{{ method }} {{ endpoint }}"
            }],
            "fieldConfig": {
              "defaults": {
                "unit": "reqps",
                "custom": {"drawStyle": "line", "fillOpacity": 10}
              }
            }
          },
          {
            "title": "HTTP Latency Percentiles",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
            "type": "timeseries",
            "targets": [
              {
                "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket{job=\"seedtest-api\"}[5m]))",
                "legendFormat": "P50"
              },
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job=\"seedtest-api\"}[5m]))",
                "legendFormat": "P95"
              },
              {
                "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{job=\"seedtest-api\"}[5m]))",
                "legendFormat": "P99"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "s"
              }
            }
          },
          {
            "title": "Governance Bundle Status",
            "gridPos": {"h": 4, "w": 6, "x": 0, "y": 12},
            "type": "stat",
            "targets": [{
              "expr": "governance_bundle_loaded{job=\"seedtest-api\"}",
              "legendFormat": "{{ bundle_id }} (phase {{ phase }})"
            }],
            "options": {
              "colorMode": "background",
              "textMode": "value_and_name"
            },
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "steps": [
                    {"value": 0, "color": "red"},
                    {"value": 1, "color": "green"}
                  ]
                },
                "mappings": [
                  {"type": "value", "value": "0", "text": "Failed"},
                  {"type": "value", "value": "1", "text": "Loaded"}
                ]
              }
            }
          },
          {
            "title": "Policy Evaluation Rate",
            "gridPos": {"h": 4, "w": 6, "x": 6, "y": 12},
            "type": "stat",
            "targets": [{
              "expr": "sum(rate(policy_evaluations_total{job=\"seedtest-api\"}[5m]))",
              "legendFormat": "Evaluations/s"
            }],
            "fieldConfig": {
              "defaults": {
                "unit": "ops"
              }
            }
          },
          {
            "title": "Policy Deny Rate (%)",
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 12},
            "type": "stat",
            "targets": [{
              "expr": "sum(rate(policy_deny_total{job=\"seedtest-api\"}[5m])) / sum(rate(policy_evaluations_total{job=\"seedtest-api\"}[5m])) * 100",
              "legendFormat": "Deny %"
            }],
            "options": {
              "colorMode": "background"
            },
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "thresholds": {
                  "steps": [
                    {"value": 0, "color": "green"},
                    {"value": 10, "color": "yellow"},
                    {"value": 30, "color": "red"}
                  ]
                }
              }
            }
          },
          {
            "title": "Policy Evaluation Latency",
            "gridPos": {"h": 4, "w": 6, "x": 18, "y": 12},
            "type": "stat",
            "targets": [{
              "expr": "histogram_quantile(0.95, rate(policy_evaluation_duration_seconds_bucket{job=\"seedtest-api\"}[5m]))",
              "legendFormat": "P95"
            }],
            "fieldConfig": {
              "defaults": {
                "unit": "s",
                "thresholds": {
                  "steps": [
                    {"value": 0, "color": "green"},
                    {"value": 0.05, "color": "yellow"},
                    {"value": 0.1, "color": "red"}
                  ]
                }
              }
            }
          },
          {
            "title": "Policy Deny/Allow Rate by Action",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
            "type": "timeseries",
            "targets": [
              {
                "expr": "sum(rate(policy_deny_total{job=\"seedtest-api\"}[5m])) by (action, phase)",
                "legendFormat": "Deny - {{ action }} (phase {{ phase }})"
              },
              {
                "expr": "sum(rate(policy_allow_total{job=\"seedtest-api\"}[5m])) by (action, phase)",
                "legendFormat": "Allow - {{ action }} (phase {{ phase }})"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "ops"
              }
            }
          },
          {
            "title": "Policy Denials by Role & Reason",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
            "type": "timeseries",
            "targets": [{
              "expr": "sum(rate(policy_deny_total{job=\"seedtest-api\"}[5m])) by (role, reason)",
              "legendFormat": "{{ role }} - {{ reason }}"
            }],
            "fieldConfig": {
              "defaults": {
                "unit": "ops"
              }
            }
          },
          {
            "title": "Bundle Reload Success Rate",
            "gridPos": {"h": 6, "w": 12, "x": 0, "y": 24},
            "type": "timeseries",
            "targets": [
              {
                "expr": "sum(rate(governance_bundle_reload_total{job=\"seedtest-api\", status=\"success\"}[5m])) by (bundle_id)",
                "legendFormat": "Success - {{ bundle_id }}"
              },
              {
                "expr": "sum(rate(governance_bundle_reload_total{job=\"seedtest-api\", status=\"error\"}[5m])) by (bundle_id)",
                "legendFormat": "Error - {{ bundle_id }}"
              }
            ]
          },
          {
            "title": "IRT Drift Flagged Items",
            "gridPos": {"h": 6, "w": 12, "x": 12, "y": 24},
            "type": "timeseries",
            "targets": [{
              "expr": "irt_drift_flagged_items{job=\"seedtest-api\"}",
              "legendFormat": "Flagged Items"
            }],
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "steps": [
                    {"value": 0, "color": "green"},
                    {"value": 10, "color": "yellow"},
                    {"value": 20, "color": "red"}
                  ]
                }
              }
            }
          },
          {
            "title": "Database Connection Pool",
            "gridPos": {"h": 6, "w": 8, "x": 0, "y": 30},
            "type": "timeseries",
            "targets": [{
              "expr": "db_connections_active{job=\"seedtest-api\"}",
              "legendFormat": "Active Connections"
            }],
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "steps": [
                    {"value": 0, "color": "green"},
                    {"value": 70, "color": "yellow"},
                    {"value": 90, "color": "red"}
                  ]
                }
              }
            }
          },
          {
            "title": "Database Query Latency (P95)",
            "gridPos": {"h": 6, "w": 8, "x": 8, "y": 30},
            "type": "timeseries",
            "targets": [{
              "expr": "histogram_quantile(0.95, rate(db_query_duration_seconds_bucket{job=\"seedtest-api\"}[5m])) by (query_type)",
              "legendFormat": "{{ query_type }}"
            }],
            "fieldConfig": {
              "defaults": {
                "unit": "s"
              }
            }
          },
          {
            "title": "Database Errors",
            "gridPos": {"h": 6, "w": 8, "x": 16, "y": 30},
            "type": "timeseries",
            "targets": [{
              "expr": "sum(rate(db_errors_total{job=\"seedtest-api\"}[5m])) by (error_type)",
              "legendFormat": "{{ error_type }}"
            }]
          }
        ]
      }
    }
