# LLM 스마트 라우팅 Nginx 설정
# ==============================
# Accept-Language 기반 1차 라우팅 (선택 사항)

# Accept-Language에서 언어 추출
map $http_accept_language $pref_lang {
    default "ko";
    "~*zh\-hant" "zh-Hant";
    "~*zh\-hans" "zh-Hans";
    "~*zh"       "zh-Hans";
    "~*ko"       "ko";
    "~*en"       "en";
}

# 쿼리 파라미터 강제 언어
map $arg_lang $forced_q {
    default "";
    "~^(ko|en|zh-Hans|zh-Hant)$" $arg_lang;
}

# X-Lang 헤더 강제 언어
map $http_x_lang $forced_h {
    default "";
    "~^(ko|en|zh-Hans|zh-Hant)$" $http_x_lang;
}

# 최종 라우팅 언어 결정 (강제 > Accept-Language)
map "$forced_q$forced_h$pref_lang" $route_lang {
    default $pref_lang;
    "~^zh\-Hant" "zh-Hant";
    "~^zh\-Hans" "zh-Hans";
    "~^en" "en";
    "~^ko" "ko";
}

# 업스트림 정의
upstream llm_local_ko {
    server 127.0.0.1:9001;
    keepalive 32;
}

upstream llm_local_en {
    server 127.0.0.1:9002;
    keepalive 32;
}

upstream llm_deepseek {
    # DeepSeek 클라우드 (내부 프록시 또는 직접 연결)
    server deepseek.api.internal:9443;
    keepalive 16;
}

server {
    listen 443 ssl http2;
    server_name api.dreamseedai.com;

    # SSL 설정
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # LLM 채팅 엔드포인트
    location /v1/chat {
        # 라우팅 언어 헤더 추가
        proxy_set_header X-Route-Lang $route_lang;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 타임아웃 설정
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 중국어 → DeepSeek 클라우드
        if ($route_lang ~* ^zh) {
            proxy_pass https://llm_deepseek;
            break;
        }

        # 영어 → 로컬 EN
        if ($route_lang = en) {
            proxy_pass http://llm_local_en;
            break;
        }

        # 기본 (한국어) → 로컬 KO
        proxy_pass http://llm_local_ko;
    }

    # 헬스 체크
    location /healthz {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}
