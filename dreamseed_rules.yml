# DreamSeed 알림 규칙
groups:
  - name: dreamseed.rules
    rules:
      # API 서버 상태
      - alert: DreamSeedAPIDown
        expr: up{job="dreamseed-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "DreamSeed API 서버가 다운되었습니다"
          description: "DreamSeed API 서버가 1분 이상 응답하지 않습니다."

      # 높은 응답 시간
      - alert: HighResponseTime
        expr: http_request_duration_seconds{job="dreamseed-api",quantile="0.95"} > 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "DreamSeed API 응답 시간이 높습니다"
          description: "95% 응답 시간이 1초를 초과했습니다."

      # 높은 에러율
      - alert: HighErrorRate
        expr: rate(http_requests_total{job="dreamseed-api",status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "DreamSeed API 에러율이 높습니다"
          description: "5분간 5xx 에러율이 10%를 초과했습니다."

      # 메모리 사용량 높음
      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "시스템 메모리 사용량이 높습니다"
          description: "메모리 사용률이 90%를 초과했습니다."

      # 디스크 사용량 높음
      - alert: HighDiskUsage
        expr: (node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "디스크 사용량이 높습니다"
          description: "디스크 사용률이 90%를 초과했습니다."

      # CPU 사용량 높음
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPU 사용량이 높습니다"
          description: "CPU 사용률이 80%를 초과했습니다."

      # Redis 연결 실패
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis 서버가 다운되었습니다"
          description: "Redis 서버가 1분 이상 응답하지 않습니다."

      # 캐시 히트율 낮음
      - alert: LowCacheHitRate
        expr: (redis_keyspace_hits_total / (redis_keyspace_hits_total + redis_keyspace_misses_total)) < 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis 캐시 히트율이 낮습니다"
          description: "캐시 히트율이 80% 미만입니다."

      # 데이터베이스 연결 실패
      - alert: DatabaseConnectionFailed
        expr: increase(dreamseed_db_connection_errors_total[5m]) > 5
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "데이터베이스 연결 실패가 많습니다"
          description: "5분간 데이터베이스 연결 실패가 5회를 초과했습니다."

      # API 요청 수 급증
      - alert: HighAPITraffic
        expr: rate(http_requests_total{job="dreamseed-api"}[5m]) > 100
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "API 요청 수가 급증했습니다"
          description: "5분간 평균 API 요청 수가 100/초를 초과했습니다."

