<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamSeedAI Question Editor - Quill.js + MathJax + Kekule.js</title>

    <!-- Quill.js CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">

    <!-- Kekule.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/kekule/dist/themes/default/kekule.css" />
    
    <!-- ChemDoodle ìŠ¤íƒ€ì¼ ì¶”ê°€ -->
    <style>
        .chem-structure {
            display: inline-block;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 10px;
            margin: 5px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .chem-structure:hover {
            background: #e9ecef;
            border-color: #0056b3;
        }
        .chem-canvas {
            display: block;
            margin: 0 auto;
        }
        .chem-blot {
            display: inline-block;
            margin: 5px;
            text-align: center;
        }

        /* ChemDoodle Modal */
        .chem-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }

        .chem-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
        }

        .chem-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }

        .chem-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .chem-modal-close:hover {
            color: #dc3545;
        }

        .chem-sketcher-container {
            margin: 20px 0;
            text-align: center;
        }

        .chem-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .chem-modal-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .chem-modal-actions button:first-child {
            background: #007bff;
            color: white;
        }

        .chem-modal-actions button:first-child:hover {
            background: #0056b3;
        }

        .chem-modal-actions button:last-child {
            background: #6c757d;
            color: white;
        }

        .chem-modal-actions button:last-child:hover {
            background: #545b62;
        }
    </style>

    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            },
            startup: {
                typeset: false
            }
        };
    </script>

    <!-- MathJax Script -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
            onerror="loadLocalMathJax()"></script>

    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --error-color: #dc3545;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --accent-color: #4dabf7;
            --success-color: #51cf66;
            --warning-color: #ffd43b;
            --error-color: #ff6b6b;
            --shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ ì¶”ê°€ */
        }

        .left-panel {
            width: 350px;
            min-width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .search-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .input-group input {
            flex: 1;
            min-width: 80px;
        }

        .input-group button {
            white-space: nowrap;
            min-width: 60px;
        }

        input, button {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        button {
            background: var(--accent-color);
            color: white;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        .status-bar {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            font-size: 12px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .status-ok { color: var(--success-color); }
        .status-fail { color: var(--error-color); }
        .status-loading { color: var(--warning-color); }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            border-bottom-color: var(--accent-color);
            background: var(--bg-primary);
        }

        .tab-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Quill Editor Styles */
        .editor-container {
            height: 400px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
        }

        .ql-editor {
            color: var(--text-primary);
            background: var(--bg-primary);
        }

        .ql-toolbar {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .ql-toolbar .ql-stroke {
            stroke: var(--text-primary);
        }

        .ql-toolbar .ql-fill {
            fill: var(--text-primary);
        }

        .ql-toolbar button:hover {
            background: var(--bg-primary);
        }

        /* Custom Toolbar Buttons */
        .ql-toolbar button[title="ìˆ˜ì‹ ì‚½ì…"],
        .ql-toolbar button[title="í™”í•™ êµ¬ì¡° ì‚½ì…"] {
            background: var(--accent-color);
            color: white;
            border: 1px solid var(--accent-color);
            border-radius: 3px;
            margin: 0 2px;
            font-weight: bold;
        }

        .ql-toolbar button[title="ìˆ˜ì‹ ì‚½ì…"]:hover,
        .ql-toolbar button[title="í™”í•™ êµ¬ì¡° ì‚½ì…"]:hover {
            background: #0056b3;
            border-color: #0056b3;
        }

        /* Custom Blot Styles */
        .ql-mathjax {
            display: inline-block;
            margin: 0 2px;
            vertical-align: middle;
        }

        .ql-chem {
            display: inline-block;
            margin: 0 2px;
            vertical-align: middle;
            max-width: 200px;
            height: auto;
        }

        /* Dark Theme Overrides */
        [data-theme="dark"] .ql-editor {
            color: var(--text-primary);
            background: var(--bg-primary);
        }

        [data-theme="dark"] .ql-toolbar {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .ql-toolbar .ql-stroke {
            stroke: var(--text-primary);
        }

        [data-theme="dark"] .ql-toolbar .ql-fill {
            fill: var(--text-primary);
        }

        /* ChemDoodle Modal */
        .chem-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
        }

        .chem-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            min-width: 600px;
            min-height: 400px;
        }

        .chem-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .chem-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-primary);
        }

        .chem-sketcher-container {
            width: 100%;
            height: 300px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .chem-modal-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* List Styles */
        .list-item {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .list-item:hover {
            background: var(--bg-secondary);
        }

        .list-item.selected {
            background: var(--accent-color);
            color: white;
        }

        /* Preview Styles */
        .preview-content {
            background: var(--bg-primary);
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-height: 200px;
        }

        /* Resizable Panels */
        .resize-handle {
            width: 4px;
            background: var(--border-color);
            cursor: col-resize;
            transition: background 0.2s;
        }

        .resize-handle:hover {
            background: var(--accent-color);
        }

        /* Inline Editing */
        .editable-content {
            position: relative;
            cursor: pointer;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 0.5rem;
            transition: all 0.2s;
        }

        .editable-content:hover {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
        }

        .editable-content.editing {
            border-color: var(--accent-color);
            background: var(--bg-primary);
        }
        
        /* Ensure Quill toolbar is visible */
        .ql-toolbar {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .editor-container .ql-toolbar {
            border: 1px solid var(--border-color);
            border-radius: 4px 4px 0 0;
            background: var(--bg-secondary);
        }
        
        .editor-container .ql-container {
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 4px 4px;
            background: var(--bg-primary);
            max-height: 400px; /* ìµœëŒ€ ë†’ì´ ì œí•œ */
            overflow-y: auto; /* ì—ë””í„° ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
        }
        
        .editor-container {
            max-height: 500px; /* ì „ì²´ ì—ë””í„° ì»¨í…Œì´ë„ˆ ë†’ì´ ì œí•œ */
            overflow-y: auto; /* ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ */
        }

        .edit-indicator {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .editable-content:hover .edit-indicator {
            opacity: 1;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--border-color);
        }

        .section-title {
            font-weight: bold;
            color: var(--text-primary);
        }

        .section-actions {
            display: flex;
            gap: 0.25rem;
        }

        .section-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            min-width: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .left-panel {
                width: 100%;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel -->
        <div class="left-panel" id="leftPanel">
            <div class="header">
                <h3>Question Editor</h3>
                <button id="themeToggle" onclick="toggleTheme()">ğŸŒ™</button>
            </div>

            <div class="search-section">
                <div class="input-group">
                    <input type="text" id="searchInput" placeholder="Original ID" value="11384">
                    <input type="number" id="rangeCount" placeholder="Count" min="1" max="100">
                    <button onclick="searchByOriginalId()">ê²€ìƒ‰</button>
                    <button onclick="searchRangeList()">ë¦¬ìŠ¤íŠ¸</button>
                </div>
            </div>

            <div class="status-bar">
                <div class="status-item">
                    <span>MathJax:</span>
                    <span id="mathjaxStatus" class="status-loading">Loading...</span>
                </div>
                <div class="status-item">
                    <span>ChemDoodle:</span>
                    <span id="chemStatus" class="status-loading">Loading...</span>
                </div>
                <div class="status-item">
                    <span>Network:</span>
                    <span id="networkStatus" class="status-loading">Loading...</span>
                </div>
            </div>

            <div id="listContainer" style="flex: 1; overflow-y: auto; padding: 1rem;">
                <!-- List items will be populated here -->
            </div>
        </div>

        <!-- Resize Handle -->
        <div class="resize-handle" id="resizeHandle"></div>

        <!-- Right Panel -->
        <div class="right-panel" id="rightPanel">
            <div class="header">
                <h3 id="questionTitle">Question Editor</h3>
            </div>

            <div class="content-area">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('view')">View</div>
                    <div class="tab" onclick="switchTab('edit')">Edit</div>
                    <div class="tab" onclick="switchTab('preview')">Preview</div>
                    <div class="tab" onclick="switchTab('raw')">Raw JSON</div>
                </div>

                <!-- View Tab -->
                <div id="viewTab" class="tab-content active">
                    <div id="viewContent">
                        <p>ê²€ìƒ‰í•˜ì—¬ ë¬¸ì œë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                    </div>
                </div>

                <!-- Edit Tab -->
                <div id="editTab" class="tab-content">
                    <div class="editor-container" id="questionEditor"></div>
                    <div style="margin-top: 1rem;">
                        <button onclick="saveCurrent()">ì €ì¥</button>
                        <button onclick="resetEditor()">ì›ë³µ</button>
                    </div>
                </div>

                <!-- Preview Tab -->
                <div id="previewTab" class="tab-content">
                    <div id="previewContent" class="preview-content">
                        <p>í¸ì§‘ ë‚´ìš©ì„ ë¯¸ë¦¬ë³´ê¸°í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>

                <!-- Raw JSON Tab -->
                <div id="rawTab" class="tab-content">
                    <pre id="rawContent" style="background: var(--bg-secondary); padding: 1rem; border-radius: 4px; overflow: auto; max-height: 500px;"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- ChemDoodle Modal -->
    <div id="chemModal" class="chem-modal">
        <div class="chem-modal-content">
            <div class="chem-modal-header">
                <h3>í™”í•™ êµ¬ì¡° í¸ì§‘</h3>
                <button class="chem-modal-close" onclick="closeChemModal()">&times;</button>
            </div>
            <div id="chemSketcher" class="chem-sketcher-container">
                <canvas id="chem-sketch" width="520" height="360"></canvas>
            </div>
            <div class="chem-modal-actions">
                <button onclick="insertChemStructure()">ì‚½ì…</button>
                <button onclick="closeChemModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js" onerror="loadLocalQuill()"></script>
    <!-- Kekule.js JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/kekule/dist/kekule.min.js"></script>

    <script>
        // Global variables
        let quill;
        let currentData = null;
        let originalContent = null;
        let mathjaxReady = false;
        let chemReady = false;
        let networkOnline = false;

        // API Configuration
        const API_BASE = 'http://127.0.0.1:8008/api';
        const IMG_BASE = '/images/editor/';

        // ChemDoodle Sketcher
        let chemSketcher = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            initMathJax();
            initChemDoodle();
            initQuill();
            checkNetworkStatus();
            loadInitialData();
        });

        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeButton(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
        }

        function updateThemeButton(theme) {
            const button = document.getElementById('themeToggle');
            button.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        // MathJax Initialization
        window.initMathJax = function() {
            if (window.MathJax && window.MathJax.typesetPromise) {
                mathjaxReady = true;
                document.getElementById('mathjaxStatus').innerHTML = '<span class="status-ok">OK</span>';
            } else {
                setTimeout(initMathJax, 100);
            }
        }

        function loadLocalMathJax() {
            console.warn('[MATHJAX] CDN ì‹¤íŒ¨, ë¡œì»¬ ë¡œë“œ ì‹œë„');
            const script = document.createElement('script');
            script.src = '/assets/mathjax/tex-mml-chtml.js';
            script.onerror = () => {
                console.error('[MATHJAX] ë¡œì»¬ ë¡œë“œë„ ì‹¤íŒ¨');
                document.getElementById('mathjaxStatus').innerHTML = '<span class="status-fail">FAIL</span>';
            };
            document.head.appendChild(script);
        }

        // Kekule.js ì´ˆê¸°í™”
        window.initChemDoodle = function() {
            console.log('[CHEM] Kekule.js ì´ˆê¸°í™” ì‹œì‘');
            
            // Kekule.js ë¡œë“œ í™•ì¸
            if (window.Kekule && window.Kekule.ChemWidget) {
                console.log('[CHEM] Kekule.js ë¡œë“œ ì™„ë£Œ');
                document.getElementById('chemStatus').innerHTML = '<span class="status-ok">OK</span>';
                chemReady = true;
            } else {
                console.log('[CHEM] Kekule.js ë¡œë“œ ëŒ€ê¸° ì¤‘...');
                document.getElementById('chemStatus').innerHTML = '<span class="status-loading">Loading...</span>';
                // 100ms í›„ ì¬ì‹œë„
                setTimeout(initChemDoodle, 100);
            }
        }

        function loadLocalChemDoodle() {
            console.warn('[CHEM] CDN ì‹¤íŒ¨, ChemDoodle ì—†ì´ ê³„ì† ì§„í–‰');
            // ChemDoodleê°€ ì—†ì–´ë„ ì—ë””í„°ëŠ” ì‘ë™í•˜ë„ë¡ í•¨
            document.getElementById('chemStatus').innerHTML = '<span class="status-warning">CDN FAIL</span>';
            // ChemDoodle ê´€ë ¨ ê¸°ëŠ¥ ë¹„í™œì„±í™”
            window.ChemDoodle = null;
        }

        // Quill Editor Initialization
        function initQuill() {
            // Register custom blots
            registerCustomBlots();

            // Initialize Quill
            quill = new Quill('#questionEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'header': [1, 2, 3, false] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['blockquote', 'code-block'],
                        ['link', 'image'],
                        ['formula', 'chem'], // Custom buttons
                        ['clean']
                    ]
                },
                placeholder: 'ë¬¸ì œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...'
            });

            // Add custom toolbar handlers
            const toolbar = quill.getModule('toolbar');

            // Add custom buttons to toolbar
            const formulaButton = document.createElement('button');
            formulaButton.innerHTML = 'fx';
            formulaButton.title = 'ìˆ˜ì‹ ì‚½ì…';
            formulaButton.onclick = insertMathFormula;

            // í™”í•™ êµ¬ì¡° ì‚½ì… ë²„íŠ¼ ì¶”ê°€
            const chemButton = document.createElement('button');
            chemButton.innerHTML = 'ğŸ§ª';
            chemButton.title = 'í™”í•™ êµ¬ì¡° ì‚½ì…';
            chemButton.onclick = openChemModal;

            // Insert custom buttons into toolbar
            const toolbarContainer = quill.container.querySelector('.ql-toolbar');
            if (toolbarContainer) {
                const cleanButton = toolbarContainer.querySelector('.ql-clean');
                if (cleanButton) {
                    cleanButton.parentNode.insertBefore(formulaButton, cleanButton);
                    cleanButton.parentNode.insertBefore(chemButton, cleanButton);
                } else {
                    toolbarContainer.appendChild(formulaButton);
                    toolbarContainer.appendChild(chemButton);
                }
            }

            // Listen for content changes
            quill.on('text-change', updatePreview);
        }

        function loadLocalQuill() {
            console.warn('[QUILL] CDN ì‹¤íŒ¨, ë¡œì»¬ ë¡œë“œ ì‹œë„');
            const script = document.createElement('script');
            script.src = '/assets/quill/quill.min.js';
            script.onerror = () => {
                console.error('[QUILL] ë¡œì»¬ ë¡œë“œë„ ì‹¤íŒ¨');
            };
            document.head.appendChild(script);
        }

        // Custom Blots Registration
        function registerCustomBlots() {
            // MathJax Formula Blot
            const MathJaxBlot = Quill.import('blots/embed');

            class MathJaxFormula extends MathJaxBlot {
                static create(value) {
                    const node = super.create();
                    node.setAttribute('class', 'ql-mathjax');
                    node.setAttribute('data-latex', value);
                    node.contentEditable = false;

                    // Render with MathJax
                    if (mathjaxReady) {
                        renderMathJaxFormula(node, value);
                    } else {
                        node.innerHTML = `$${value}$`;
                    }

                    return node;
                }

                static value(node) {
                    return node.getAttribute('data-latex');
                }
            }

            MathJaxFormula.blotName = 'mathjax';
            MathJaxFormula.tagName = 'span';
            Quill.register(MathJaxFormula);

            // ChemDoodle ëŒ€ì•ˆ - ê°„ë‹¨í•œ í™”í•™ êµ¬ì¡° Blot
            const ChemBlot = Quill.import('blots/embed');

            class ChemStructure extends ChemBlot {
                static create(value) {
                    const node = super.create();
                    node.setAttribute('class', 'ql-chem chem-structure');
                    node.setAttribute('data-smiles', value);
                    node.contentEditable = false;
                    node.title = 'í™”í•™ êµ¬ì¡° - í´ë¦­í•˜ì—¬ í¸ì§‘';

                    // ChemDoodle ë Œë”ë§ ì»¨í…Œì´ë„ˆ ìƒì„±
                    const container = document.createElement('div');
                    container.className = 'chem-blot';
                    node.appendChild(container);

                    // ChemDoodle ë Œë”ë§
                    renderChemStructure(container, value, 300, 200);

                    // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    node.addEventListener('click', function() {
                        editChemStructure(this);
                    });

                    return node;
                }

                static value(node) {
                    return node.getAttribute('data-smiles');
                }
            }

            ChemStructure.blotName = 'chem';
            ChemStructure.tagName = 'img';
            Quill.register(ChemStructure);
        }

        // MathJax Rendering
        function renderMathJaxFormula(node, latex) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `$$${latex}$$`;

            MathJax.typesetPromise([tempDiv]).then(() => {
                const mathElement = tempDiv.querySelector('.MathJax');
                if (mathElement) {
                    node.innerHTML = mathElement.outerHTML;
                } else {
                    node.innerHTML = `$$${latex}$$`;
                }
            }).catch(() => {
                node.innerHTML = `$$${latex}$$`;
            });
        }

        // ChemDoodle Rendering
        function renderChemStructure(container, smiles, width = 420, height = 300) {
            const K = window.Kekule;
            
            // Kekule.jsê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¬ì‹œë„
            if (!K || !K.ChemWidget || !K.IO) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Loading Kekule.js...</div>';
                setTimeout(() => renderChemStructure(container, smiles, width, height), 250);
                return;
            }

            // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
            container.innerHTML = '';
            
            try {
                // SMILES íŒŒì‹± - ë‹¤ì–‘í•œ í¬ë§· ì‹œë„
                let chemObj = null;
                
                // ë¨¼ì € 'smi' í¬ë§· ì‹œë„
                try {
                    chemObj = K.IO.loadFormatData(smiles, 'smi');
                } catch (e1) {
                    console.log('[CHEM] smi í¬ë§· ì‹¤íŒ¨, ë‹¤ë¥¸ í¬ë§· ì‹œë„:', e1.message);
                    
                    // 'smiles' í¬ë§· ì‹œë„
                    try {
                        chemObj = K.IO.loadFormatData(smiles, 'smiles');
                    } catch (e2) {
                        console.log('[CHEM] smiles í¬ë§· ì‹¤íŒ¨, mol í¬ë§· ì‹œë„:', e2.message);
                        
                        // 'mol' í¬ë§· ì‹œë„
                        try {
                            chemObj = K.IO.loadFormatData(smiles, 'mol');
                        } catch (e3) {
                            console.log('[CHEM] mol í¬ë§· ì‹¤íŒ¨, ê¸°ë³¸ íŒŒì‹± ì‹œë„:', e3.message);
                            
                            // ê¸°ë³¸ íŒŒì‹± ì‹œë„
                            try {
                                chemObj = K.IO.loadFormatData(smiles);
                            } catch (e4) {
                                console.error('[CHEM] ëª¨ë“  í¬ë§· ì‹¤íŒ¨:', e4.message);
                                throw e4;
                            }
                        }
                    }
                }
                
                if (chemObj) {
                    // Kekule ë·°ì–´ ìƒì„±
                    const viewer = new K.ChemWidget.Viewer(container);
                    viewer.setDimension(width, height);
                    viewer.setChemObj(chemObj);
                    console.log('[CHEM] í™”í•™ êµ¬ì¡° ë Œë”ë§ ì„±ê³µ:', smiles);
                } else {
                    container.innerHTML = `<div style="padding: 20px; text-align: center; color: #dc3545;">Invalid SMILES: ${smiles}</div>`;
                }
            } catch (e) {
                console.error('Kekule.js rendering error:', e);
                // ëŒ€ì•ˆ: ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ í‘œì‹œ
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666; border: 1px solid #ddd; border-radius: 4px;">
                        <p><strong>í™”í•™ êµ¬ì¡°:</strong> ${smiles}</p>
                        <p style="font-size: 12px; color: #999;">SMILES í‘œê¸°ë²•</p>
                    </div>
                `;
            }
        }

        // Custom Toolbar Handlers
        function insertMathFormula() {
            openMathEditor();
        }

        function openMathEditor() {
            // ìˆ˜ì‹ í¸ì§‘ê¸° ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.id = 'mathModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 800px; max-height: 80%; overflow-y: auto;">
                    <h3>ìˆ˜ì‹ í¸ì§‘ê¸°</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <button onclick="showMathTab('student')" class="math-tab-btn active" style="padding: 8px 16px; border: 1px solid #ddd; background: #28a745; color: white; cursor: pointer; border-radius: 4px; font-weight: bold;">ğŸ“ í•™ìƒìš©</button>
                            <button onclick="showMathTab('basic')" class="math-tab-btn" style="padding: 8px 16px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 4px;">ê¸°ë³¸</button>
                            <button onclick="showMathTab('advanced')" class="math-tab-btn" style="padding: 8px 16px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 4px;">ê³ ê¸‰</button>
                            <button onclick="showMathTab('greek')" class="math-tab-btn" style="padding: 8px 16px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 4px;">ê·¸ë¦¬ìŠ¤</button>
                            <button onclick="showMathTab('symbols')" class="math-tab-btn" style="padding: 8px 16px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 4px;">ê¸°í˜¸</button>
                            <button onclick="showMathTab('functions')" class="math-tab-btn" style="padding: 8px 16px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 4px;">í•¨ìˆ˜</button>
                            <button onclick="showMathTab('matrices')" class="math-tab-btn" style="padding: 8px 16px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 4px;">í–‰ë ¬</button>
                            <button onclick="showMathTab('geometry')" class="math-tab-btn" style="padding: 8px 16px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 4px;">ê¸°í•˜í•™</button>
                            <button onclick="showMathTab('operators')" class="math-tab-btn" style="padding: 8px 16px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 4px;">ì—°ì‚°ì</button>
                        </div>
                        
                        <!-- í•™ìƒìš© íƒ­ -->
                        <div id="math-tab-student" class="math-tab-content" style="display: block;">
                            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #28a745;">
                                <h4 style="margin: 0 0 10px 0; color: #155724;">ğŸ“ Grade 10 í•™ìƒë“¤ì„ ìœ„í•œ ê°„ë‹¨í•œ ìˆ˜í•™ ê¸°í˜¸</h4>
                                <p style="margin: 0; color: #155724; font-size: 14px;">ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ìì£¼ ì‚¬ìš©í•˜ëŠ” ìˆ˜í•™ ê¸°í˜¸ê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤!</p>
                            </div>
                            
                            <!-- ê¸°ë³¸ ì—°ì‚° -->
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: #333; margin-bottom: 10px;">â• ê¸°ë³¸ ì—°ì‚°</h5>
                                <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; padding: 15px; border: 2px solid #28a745; border-radius: 8px; background: #f8fff8;">
                                    <button class="math-btn" onclick="insertMathSymbol('\\\\frac{a}{b}')" style="padding: 10px 15px; border: 2px solid #28a745; background: #28a745; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ë¶„ìˆ˜</button>
                                    <button class="math-btn" onclick="insertMathSymbol('x^2')" style="padding: 10px 15px; border: 2px solid #28a745; background: #28a745; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì œê³±</button>
                                    <button class="math-btn" onclick="insertMathSymbol('\\\\sqrt{x}')" style="padding: 10px 15px; border: 2px solid #28a745; background: #28a745; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ë£¨íŠ¸</button>
                                    <button class="math-btn" onclick="insertMathSymbol('\\\\sqrt[3]{x}')" style="padding: 10px 15px; border: 2px solid #28a745; background: #28a745; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì„¸ì œê³±ê·¼</button>
                                </div>
                            </div>
                            
                            <!-- ì‚¼ê°í•¨ìˆ˜ -->
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: #333; margin-bottom: 10px;">ğŸ“ ì‚¼ê°í•¨ìˆ˜</h5>
                                <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; padding: 15px; border: 2px solid #17a2b8; border-radius: 8px; background: #f0f8ff;">
                                    <button class="math-btn" onclick="insertMathSymbol('\\\\sin x')" style="padding: 10px 15px; border: 2px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">sin x</button>
                                    <button class="math-btn" onclick="insertMathSymbol('\\\\cos x')" style="padding: 10px 15px; border: 2px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">cos x</button>
                                    <button class="math-btn" onclick="insertMathSymbol('\\\\tan x')" style="padding: 10px 15px; border: 2px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">tan x</button>
                                    <button class="math-btn" onclick="insertMathSymbol('\\\\sin^2 x')" style="padding: 10px 15px; border: 2px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">sinÂ²x</button>
                                </div>
                            </div>
                            
                            <!-- ê¸°í•˜í•™ -->
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: #333; margin-bottom: 10px;">ğŸ“ ê¸°í•˜í•™</h5>
                                <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; padding: 15px; border: 2px solid #ffc107; border-radius: 8px; background: #fffdf0;">
                                    <button class="math-btn" onclick="insertMathSymbol('\\\\angle A')" style="padding: 10px 15px; border: 2px solid #ffc107; background: #ffc107; color: #333; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ê° A</button>
                                    <button class="math-btn" onclick="insertMathSymbol('\\\\overline{AB}')" style="padding: 10px 15px; border: 2px solid #ffc107; background: #ffc107; color: #333; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì„ ë¶„ AB</button>
                                    <button class="math-btn" onclick="insertMathSymbol('\\\\triangle ABC')" style="padding: 10px 15px; border: 2px solid #ffc107; background: #ffc107; color: #333; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì‚¼ê°í˜•</button>
                                    <button class="math-btn" onclick="insertMathSymbol('\\\\pi')" style="padding: 10px 15px; border: 2px solid #ffc107; background: #ffc107; color: #333; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">Ï€ (íŒŒì´)</button>
                                </div>
                            </div>
                            
                            <!-- ëŒ€ìˆ˜í•™ ê³µì‹ -->
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: #333; margin-bottom: 10px;">ğŸ“ ëŒ€ìˆ˜í•™ ê³µì‹</h5>
                                <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; padding: 15px; border: 2px solid #dc3545; border-radius: 8px; background: #fff5f5;">
                                    <button class="math-btn" onclick="insertMathTemplate('\\\\frac{-b \\\\pm \\\\sqrt{b^2 - 4ac}}{2a}')" style="padding: 10px 15px; border: 2px solid #dc3545; background: #dc3545; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ê·¼ì˜ê³µì‹</button>
                                    <button class="math-btn" onclick="insertMathTemplate('(a + b)^2 = a^2 + 2ab + b^2')" style="padding: 10px 15px; border: 2px solid #dc3545; background: #dc3545; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì™„ì „ì œê³±</button>
                                    <button class="math-btn" onclick="insertMathTemplate('a^2 - b^2 = (a + b)(a - b)')" style="padding: 10px 15px; border: 2px solid #dc3545; background: #dc3545; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì°¨ì˜ì œê³±</button>
                                    <button class="math-btn" onclick="insertMathTemplate('(a + b)^3 = a^3 + 3a^2b + 3ab^2 + b^3')" style="padding: 10px 15px; border: 2px solid #dc3545; background: #dc3545; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì„¸ì œê³±ê³µì‹</button>
                                </div>
                            </div>
                            
                            <!-- ê¸°í•˜í•™ ê³µì‹ -->
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: #333; margin-bottom: 10px;">ğŸ“ ê¸°í•˜í•™ ê³µì‹</h5>
                                <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; padding: 15px; border: 2px solid #fd7e14; border-radius: 8px; background: #fff8f0;">
                                    <button class="math-btn" onclick="insertMathTemplate('\\\\sqrt{x^2 + y^2}')" style="padding: 10px 15px; border: 2px solid #fd7e14; background: #fd7e14; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ê±°ë¦¬ê³µì‹</button>
                                    <button class="math-btn" onclick="insertMathTemplate('A = \\\\pi r^2')" style="padding: 10px 15px; border: 2px solid #fd7e14; background: #fd7e14; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì›ì˜ë„“ì´</button>
                                    <button class="math-btn" onclick="insertMathTemplate('C = 2\\\\pi r')" style="padding: 10px 15px; border: 2px solid #fd7e14; background: #fd7e14; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì›ì˜ë‘˜ë ˆ</button>
                                    <button class="math-btn" onclick="insertMathTemplate('V = \\\\frac{4}{3}\\\\pi r^3')" style="padding: 10px 15px; border: 2px solid #fd7e14; background: #fd7e14; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">êµ¬ì˜ë¶€í”¼</button>
                                </div>
                            </div>
                            
                            <!-- ì‚¼ê°í•¨ìˆ˜ ê³µì‹ -->
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: #333; margin-bottom: 10px;">ğŸ“ ì‚¼ê°í•¨ìˆ˜ ê³µì‹</h5>
                                <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; padding: 15px; border: 2px solid #20c997; border-radius: 8px; background: #f0fff8;">
                                    <button class="math-btn" onclick="insertMathTemplate('\\\\sin^2 x + \\\\cos^2 x = 1')" style="padding: 10px 15px; border: 2px solid #20c997; background: #20c997; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">í”¼íƒ€ê³ ë¼ìŠ¤</button>
                                    <button class="math-btn" onclick="insertMathTemplate('\\\\sin(A + B) = \\\\sin A \\\\cos B + \\\\cos A \\\\sin B')" style="padding: 10px 15px; border: 2px solid #20c997; background: #20c997; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ë§ì…ˆì •ë¦¬</button>
                                    <button class="math-btn" onclick="insertMathTemplate('\\\\sin 2x = 2\\\\sin x \\\\cos x')" style="padding: 10px 15px; border: 2px solid #20c997; background: #20c997; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ë°°ê°ê³µì‹</button>
                                    <button class="math-btn" onclick="insertMathTemplate('\\\\sin x \\\\Big|_{0}^{\\\\pi}')" style="padding: 10px 15px; border: 2px solid #20c997; background: #20c997; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì •ì ë¶„</button>
                                </div>
                            </div>
                            
                            <!-- ìœ ê¸°í™”í•™ êµ¬ì¡° í…œí”Œë¦¿ -->
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: #333; margin-bottom: 10px;">ğŸ§ª ìœ ê¸°í™”í•™ êµ¬ì¡°</h5>
                                <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; padding: 15px; border: 2px solid #e83e8c; border-radius: 8px; background: #fff0f5;">
                                    <button class="math-btn" onclick="insertChemTemplate('c1ccccc1')" style="padding: 10px 15px; border: 2px solid #e83e8c; background: #e83e8c; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ë²¤ì  </button>
                                    <button class="math-btn" onclick="insertChemTemplate('CC')" style="padding: 10px 15px; border: 2px solid #e83e8c; background: #e83e8c; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì—íƒ„</button>
                                    <button class="math-btn" onclick="insertChemTemplate('C=C')" style="padding: 10px 15px; border: 2px solid #e83e8c; background: #e83e8c; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì—í‹¸ë Œ</button>
                                    <button class="math-btn" onclick="insertChemTemplate('C#C')" style="padding: 10px 15px; border: 2px solid #e83e8c; background: #e83e8c; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì•„ì„¸í‹¸ë Œ</button>
                                </div>
                                <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; padding: 15px; border: 2px solid #e83e8c; border-radius: 8px; background: #fff0f5;">
                                    <button class="math-btn" onclick="insertChemTemplate('Cc1ccccc1')" style="padding: 10px 15px; border: 2px solid #e83e8c; background: #e83e8c; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">í†¨ë£¨ì—”</button>
                                    <button class="math-btn" onclick="insertChemTemplate('Oc1ccccc1')" style="padding: 10px 15px; border: 2px solid #e83e8c; background: #e83e8c; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">í˜ë†€</button>
                                    <button class="math-btn" onclick="insertChemTemplate('CC(=O)O')" style="padding: 10px 15px; border: 2px solid #e83e8c; background: #e83e8c; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì•„ì„¸íŠ¸ì‚°</button>
                                    <button class="math-btn" onclick="insertChemTemplate('CCO')" style="padding: 10px 15px; border: 2px solid #e83e8c; background: #e83e8c; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì—íƒ„ì˜¬</button>
                                </div>
                            </div>
                            
                            <!-- ì™„ì„±ëœ ìˆ˜ì‹ í…œí”Œë¦¿ -->
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: #333; margin-bottom: 10px;">âœ¨ ê¸°íƒ€ ìœ ìš©í•œ ê³µì‹</h5>
                                <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; padding: 15px; border: 2px solid #6f42c1; border-radius: 8px; background: #f8f5ff;">
                                    <button class="math-btn" onclick="insertMathTemplate('\\\\frac{x^2 + 1}{x - 1}')" style="padding: 10px 15px; border: 2px solid #6f42c1; background: #6f42c1; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ë¶„ìˆ˜ì‹</button>
                                    <button class="math-btn" onclick="insertMathTemplate('\\\\log_a b = \\\\frac{\\\\log b}{\\\\log a}')" style="padding: 10px 15px; border: 2px solid #6f42c1; background: #6f42c1; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ë¡œê·¸ê³µì‹</button>
                                    <button class="math-btn" onclick="insertMathTemplate('e^{\\\\ln x} = x')" style="padding: 10px 15px; border: 2px solid #6f42c1; background: #6f42c1; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ì§€ìˆ˜ë¡œê·¸</button>
                                    <button class="math-btn" onclick="insertMathTemplate('\\\\lim_{x \\\\to 0} \\\\frac{\\\\sin x}{x} = 1')" style="padding: 10px 15px; border: 2px solid #6f42c1; background: #6f42c1; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px;">ê·¹í•œê³µì‹</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ê¸°ë³¸ íƒ­ -->
                        <div id="math-tab-basic" class="math-tab-content" style="display: none;">
                            <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <button class="math-btn" onclick="insertMathSymbol('\\\\frac{a}{b}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ë¶„ìˆ˜</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\sqrt{x}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ì œê³±ê·¼</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\sqrt[n]{x}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">nì œê³±ê·¼</button>
                                <button class="math-btn" onclick="insertMathSymbol('x^2')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ì œê³±</button>
                                <button class="math-btn" onclick="insertMathSymbol('x_1')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ì•„ë˜ì²¨ì</button>
                                <button class="math-btn" onclick="insertMathSymbol('x^{n}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ìœ„ì²¨ì</button>
                                <button class="math-btn" onclick="insertMathSymbol('x_{i}^{j}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ìœ„ì•„ë˜ì²¨ì</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\pm')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Â±</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\mp')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ“</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\cdot')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Â·</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\times')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Ã—</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\div')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Ã·</button>
                            </div>
                        </div>
                        
                        <!-- ê³ ê¸‰ íƒ­ -->
                        <div id="math-tab-advanced" class="math-tab-content" style="display: none;">
                            <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <button class="math-btn" onclick="insertMathSymbol('\\\\sum_{i=1}^{n}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">í•©ê³„</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\prod_{i=1}^{n}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ê³±ì…ˆ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\int_{a}^{b}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ì ë¶„</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\int_{0}^{\\\\pi} \\\\sin x \\\\, dx')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ì •ì ë¶„</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\int_{0}^{\\\\infty} f(x) \\\\, dx')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ë¬´í•œì ë¶„</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\int_{-\\\\infty}^{\\\\infty} f(x) \\\\, dx')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ì–‘ë°©í–¥ë¬´í•œ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\sin x \\\\Big|_{0}^{\\\\pi}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">sinxë§‰ëŒ€</button>
                                <button class="math-btn" onclick="insertMathSymbol('f(x) \\\\Big|_{a}^{b}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">í•¨ìˆ˜ë§‰ëŒ€</button>
                                <button class="math-btn" onclick="insertMathSymbol('x^2 \\\\Big|_{0}^{1}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">xÂ²ë§‰ëŒ€</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\iint_{D}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ì´ì¤‘ì ë¶„</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\iiint_{V}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ì‚¼ì¤‘ì ë¶„</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\oint_{C}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ì„ ì ë¶„</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\lim_{x \\\\to \\\\infty}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ê·¹í•œ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\lim_{x \\\\to a}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ê·¹í•œ(a)</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\max')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ìµœëŒ€</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\min')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ìµœì†Œ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\sup')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ìƒí•œ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\inf')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">í•˜í•œ</button>
                            </div>
                        </div>
                        
                        <!-- ê·¸ë¦¬ìŠ¤ ë¬¸ì íƒ­ -->
                        <div id="math-tab-greek" class="math-tab-content" style="display: none;">
                            <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <button class="math-btn" onclick="insertMathSymbol('\\\\alpha')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î±</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\beta')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î²</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\gamma')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î³</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\delta')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î´</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\epsilon')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Îµ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\zeta')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î¶</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\eta')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î·</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\theta')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î¸</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\iota')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î¹</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\kappa')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Îº</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\lambda')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î»</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\mu')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î¼</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\nu')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î½</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\xi')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î¾</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\pi')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Ï€</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\rho')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Ï</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\sigma')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Ïƒ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\tau')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Ï„</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\upsilon')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Ï…</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\phi')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Ï†</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\chi')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Ï‡</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\psi')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Ïˆ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\omega')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Ï‰</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\Gamma')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î“</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\Delta')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î”</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\Theta')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î˜</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\Lambda')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î›</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\Pi')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î </button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\Sigma')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î£</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\Phi')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î¦</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\Omega')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Î©</button>
                            </div>
                        </div>
                        
                        <!-- ê¸°í˜¸ íƒ­ -->
                        <div id="math-tab-symbols" class="math-tab-content" style="display: none;">
                            <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <button class="math-btn" onclick="insertMathSymbol('\\\\infty')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\leq')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‰¤</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\geq')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‰¥</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\neq')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‰ </button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\approx')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‰ˆ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\equiv')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‰¡</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\propto')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\sim')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ¼</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\simeq')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‰ƒ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\cong')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‰…</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\ll')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‰ª</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\gg')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‰«</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\in')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆˆ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\notin')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ‰</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\subset')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âŠ‚</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\supset')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âŠƒ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\subseteq')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âŠ†</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\supseteq')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âŠ‡</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\cup')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆª</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\cap')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ©</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\emptyset')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ…</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\varnothing')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ…</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\rightarrow')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â†’</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\leftarrow')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â†</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\leftrightarrow')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â†”</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\Rightarrow')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‡’</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\Leftarrow')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‡</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\Leftrightarrow')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‡”</button>
                            </div>
                        </div>
                        
                        <!-- í•¨ìˆ˜ íƒ­ -->
                        <div id="math-tab-functions" class="math-tab-content" style="display: none;">
                            <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <button class="math-btn" onclick="insertMathSymbol('\\\\sin')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">sin</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\cos')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">cos</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\tan')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">tan</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\cot')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">cot</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\sec')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">sec</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\csc')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">csc</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\arcsin')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">arcsin</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\arccos')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">arccos</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\arctan')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">arctan</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\sinh')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">sinh</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\cosh')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">cosh</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\tanh')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">tanh</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\log')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">log</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\ln')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ln</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\lg')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">lg</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\exp')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">exp</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\det')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">det</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\dim')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">dim</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\ker')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ker</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\deg')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">deg</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\gcd')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">gcd</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\lcm')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">lcm</button>
                            </div>
                        </div>
                        
                        <!-- í–‰ë ¬ íƒ­ -->
                        <div id="math-tab-matrices" class="math-tab-content" style="display: none;">
                            <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <button class="math-btn" onclick="insertMathSymbol('\\\\begin{pmatrix} a & b \\\\\\\\ c & d \\\\end{pmatrix}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">2Ã—2í–‰ë ¬</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\begin{pmatrix} a & b & c \\\\\\\\ d & e & f \\\\\\\\ g & h & i \\\\end{pmatrix}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">3Ã—3í–‰ë ¬</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\begin{bmatrix} a & b \\\\\\\\ c & d \\\\end{bmatrix}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">[2Ã—2]</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\begin{vmatrix} a & b \\\\\\\\ c & d \\\\end{vmatrix}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">|2Ã—2|</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\begin{Vmatrix} a & b \\\\\\\\ c & d \\\\end{Vmatrix}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â€–2Ã—2â€–</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\begin{pmatrix} a \\\\\\\\ b \\\\\\\\ c \\\\end{pmatrix}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ì—´ë²¡í„°</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\begin{pmatrix} a & b & c \\\\end{pmatrix}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">í–‰ë²¡í„°</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\begin{cases} x = a \\\\\\\\ y = b \\\\end{cases}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ì—°ë¦½ë°©ì •ì‹</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\begin{align} x &= a \\\\\\\\ y &= b \\\\end{align}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ì •ë ¬ë°©ì •ì‹</button>
                            </div>
                        </div>
                        
                        <!-- ê¸°í•˜í•™ íƒ­ -->
                        <div id="math-tab-geometry" class="math-tab-content" style="display: none;">
                            <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <button class="math-btn" onclick="insertMathSymbol('\\\\angle A')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ A</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\angle ABC')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ ABC</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\measuredangle A')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ¡A</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\measuredangle ABC')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ¡ABC</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\sphericalangle A')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ¢A</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\sphericalangle ABC')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ¢ABC</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\overline{AB}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">AB</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\overline{CD}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">CD</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\overrightarrow{AB}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â†’AB</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\overleftarrow{AB}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â†AB</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\overleftrightarrow{AB}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â†”AB</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\vec{a}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâƒ—</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\vec{AB}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ABâƒ—</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\vec{v}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">vâƒ—</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\vec{u}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">uâƒ—</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\vec{i}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">iâƒ—</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\vec{j}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">jâƒ—</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\vec{k}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">kâƒ—</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\widehat{AB}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ABÌ‚</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\widehat{ABC}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ABCÌ‚</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\overset{\\\\frown}{AB}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">ABâŒ¢</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\overset{\\\\frown}{BX}')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">BXâŒ¢</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\triangle ABC')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â–³ABC</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\square ABCD')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â–¡ABCD</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\diamond ABCD')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â—‡ABCD</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\circle A')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â—‹A</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\odot A')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âŠ™A</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\perp')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âŠ¥</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\parallel')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ¥</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\cong')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‰…</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\sim')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">âˆ¼</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\equiv')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‰¡</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\not\\equiv')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‰¢</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\approx')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‰ˆ</button>
                                <button class="math-btn" onclick="insertMathSymbol('\\\\not\\approx')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">â‰‰</button>
                            </div>
                        </div>
                        
                        <!-- ì—°ì‚°ì íƒ­ -->
                        <div id="math-tab-operators" class="math-tab-content" style="display: none;">
                            <div class="math-toolbar" style="display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\oplus b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠ•b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\ominus b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠ–b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\otimes b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠ—b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\odot b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠ™b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\boxplus b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠb</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\boxminus b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠŸb</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\boxtimes b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠ b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\boxdot b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠ¡b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\star b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâ‹†b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\bullet b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâ€¢b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\circ b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâˆ˜b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\diamond b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâ‹„b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\wedge b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâˆ§b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\vee b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâˆ¨b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\cap b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâˆ©b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\cup b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâˆªb</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\sqcap b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠ“b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\sqcup b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠ”b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\uplus b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠb</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\amalg b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâ¨¿b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\bigtriangleup b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâ–³b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\bigtriangledown b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâ–½b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\triangleleft b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâ—b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\triangleright b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâ–·b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\lhd b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠ²b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\rhd b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠ³b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\unlhd b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠ´b</button>
                                <button class="math-btn" onclick="insertMathSymbol('a \\\\unrhd b')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">aâŠµb</button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin: 10px 0;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">LaTeX ì½”ë“œ:</label>
                            <textarea id="mathInput" style="width: 100%; height: 100px; border: 1px solid #ccc; padding: 10px; font-family: monospace; resize: vertical;" placeholder="LaTeX ìˆ˜ì‹ì„ ì…ë ¥í•˜ì„¸ìš”...">E = mc^2</textarea>
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ìˆ˜ì‹ ë¯¸ë¦¬ë³´ê¸°:</label>
                            <div id="mathPreview" style="border: 1px solid #ddd; padding: 10px; min-height: 100px; background: #f9f9f9; overflow: auto;">
                                <!-- ìˆ˜ì‹ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin: 10px 0; padding: 10px; background: #f0f8ff; border-radius: 4px;">
                        <h4 style="margin: 0 0 10px 0; color: #0066cc;">ğŸ¯ WYSIWYG ìˆ˜ì‹ í¸ì§‘ íŒ:</h4>
                        <div style="font-size: 14px; line-height: 1.4;">
                            <p><strong>1. ë¶„ìˆ˜:</strong> ë¶„ìˆ˜ ë²„íŠ¼ í´ë¦­ â†’ <code>a</code>ì™€ <code>b</code>ë¥¼ ì›í•˜ëŠ” ê°’ìœ¼ë¡œ ë³€ê²½</p>
                            <p><strong>2. ì œê³±/ì²¨ì:</strong> ì œê³± ë²„íŠ¼ í´ë¦­ â†’ <code>x</code>ì™€ <code>2</code>ë¥¼ ì›í•˜ëŠ” ê°’ìœ¼ë¡œ ë³€ê²½</p>
                            <p><strong>3. ë³µí•© ìˆ˜ì‹:</strong> ì—¬ëŸ¬ ë²„íŠ¼ì„ ì¡°í•©í•˜ì—¬ ë³µì¡í•œ ìˆ˜ì‹ ìƒì„±</p>
                            <p><strong>4. ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°:</strong> ì˜¤ë¥¸ìª½ì—ì„œ ìˆ˜ì‹ì´ ì¦‰ì‹œ ë Œë”ë§ë¨</p>
                            <p><strong>5. í…ìŠ¤íŠ¸ ì„ íƒ:</strong> í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ê³  ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì„ íƒëœ í…ìŠ¤íŠ¸ê°€ ì‹¬ë³¼ë¡œ ê°ì‹¸ì§‘ë‹ˆë‹¤</p>
                        </div>
                    </div>
                    
                    <div style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 4px;">
                        <h4 style="margin: 0 0 10px 0; color: #856404;">âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤:</h4>
                        <div style="font-size: 14px; line-height: 1.4;">
                            <p><strong>Ctrl + /:</strong> ì£¼ì„ í† ê¸€</p>
                            <p><strong>Ctrl + Z:</strong> ì‹¤í–‰ ì·¨ì†Œ</p>
                            <p><strong>Ctrl + Y:</strong> ë‹¤ì‹œ ì‹¤í–‰</p>
                            <p><strong>Tab:</strong> ë‹¤ìŒ í¸ì§‘ ìœ„ì¹˜ë¡œ ì´ë™</p>
                            <p><strong>Shift + Tab:</strong> ì´ì „ í¸ì§‘ ìœ„ì¹˜ë¡œ ì´ë™</p>
                        </div>
                    </div>
                    
                    <div style="margin: 10px 0; padding: 10px; background: #d1ecf1; border-radius: 4px;">
                        <h4 style="margin: 0 0 10px 0; color: #0c5460;">ğŸ”§ í¸ì§‘ ë„ìš°ë¯¸:</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="insertMathTemplate('\\frac{}{}')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">ë¹ˆ ë¶„ìˆ˜</button>
                            <button onclick="insertMathTemplate('^{}')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">ë¹ˆ ìœ„ì²¨ì</button>
                            <button onclick="insertMathTemplate('_{}')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">ë¹ˆ ì•„ë˜ì²¨ì</button>
                            <button onclick="insertMathTemplate('\\sqrt{}')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">ë¹ˆ ì œê³±ê·¼</button>
                            <button onclick="insertMathTemplate('\\left(\\right)')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">ë¹ˆ ê´„í˜¸</button>
                            <button onclick="insertMathTemplate('\\left[\\right]')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">ë¹ˆ ëŒ€ê´„í˜¸</button>
                            <button onclick="insertMathTemplate('\\left|\\right|')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">ë¹ˆ ì ˆëŒ“ê°’</button>
                            <button onclick="insertMathTemplate('\\left\\{\\right\\}')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">ë¹ˆ ì¤‘ê´„í˜¸</button>
                            <button onclick="insertMathTemplate('\\angle{}')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">ë¹ˆ ê°</button>
                            <button onclick="insertMathTemplate('\\overline{}')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">ë¹ˆ ì„ ë¶„</button>
                            <button onclick="insertMathTemplate('\\widehat{}')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">ë¹ˆ í˜¸</button>
                            <button onclick="insertMathTemplate('\\vec{}')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">ë¹ˆ ë²¡í„°</button>
                            <button onclick="insertMathTemplate('\\overrightarrow{}')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">ë¹ˆ ë°©í–¥ë²¡í„°</button>
                            <button onclick="insertMathTemplate('a \\oplus b')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">aâŠ•b</button>
                            <button onclick="insertMathTemplate('a \\odot b')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">aâŠ™b</button>
                            <button onclick="insertMathTemplate('a \\circ b')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">aâˆ˜b</button>
                            <button onclick="insertMathTemplate('\\int_{}^{} f(x) \\, dx')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">ì •ì ë¶„</button>
                            <button onclick="insertMathTemplate('\\int_{0}^{\\pi} \\sin x \\, dx')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">sinxì •ì ë¶„</button>
                            <button onclick="insertMathTemplate('f(x) \\Big|_{a}^{b}')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">í•¨ìˆ˜ë§‰ëŒ€</button>
                            <button onclick="insertMathTemplate('\\sin x \\Big|_{0}^{\\pi}')" style="padding: 5px 10px; border: 1px solid #17a2b8; background: #17a2b8; color: white; cursor: pointer; border-radius: 3px; font-size: 12px;">sinxë§‰ëŒ€</button>
                        </div>
                    </div>
                    
                    <div style="text-align: right; margin-top: 10px;">
                        <button onclick="closeMathModal()" style="padding: 8px 16px; margin-right: 10px; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer; border-radius: 4px;">ì·¨ì†Œ</button>
                        <button onclick="insertMathFromEditor()" style="padding: 8px 16px; border: 1px solid #007cba; background: #007cba; color: white; cursor: pointer; border-radius: 4px;">ì‚½ì…</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ìˆ˜ì‹ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
            updateMathPreview();
            
            // ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°
            const mathInput = document.getElementById('mathInput');
            mathInput.addEventListener('input', updateMathPreview);
            
            // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
            mathInput.addEventListener('keydown', handleMathKeyboard);
        }

        function insertMathSymbol(symbol) {
            const mathInput = document.getElementById('mathInput');
            const cursorPos = mathInput.selectionStart;
            const textBefore = mathInput.value.substring(0, cursorPos);
            const textAfter = mathInput.value.substring(mathInput.selectionEnd);
            
            // ì„ íƒëœ í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì‹¬ë³¼ë¡œ ê°ì‹¸ê¸°
            const selectedText = mathInput.value.substring(mathInput.selectionStart, mathInput.selectionEnd);
            let newSymbol = symbol;
            
            if (selectedText && symbol.includes('a') && symbol.includes('b')) {
                // ë¶„ìˆ˜ë‚˜ ë¹„ìŠ·í•œ êµ¬ì¡°ì—ì„œ ì„ íƒëœ í…ìŠ¤íŠ¸ í™œìš©
                if (symbol.includes('\\frac{a}{b}')) {
                    newSymbol = `\\frac{${selectedText}}{b}`;
                } else if (symbol.includes('x^2')) {
                    newSymbol = `${selectedText}^2`;
                } else if (symbol.includes('x_1')) {
                    newSymbol = `${selectedText}_1`;
                } else if (symbol.includes('\\sqrt{x}')) {
                    newSymbol = `\\sqrt{${selectedText}}`;
                }
            }
            
            mathInput.value = textBefore + newSymbol + textAfter;
            mathInput.focus();
            
            // ì»¤ì„œë¥¼ ì ì ˆí•œ ìœ„ì¹˜ë¡œ ì´ë™
            let newCursorPos = cursorPos + newSymbol.length;
            if (newSymbol.includes('{') && newSymbol.includes('}')) {
                // ì¤‘ê´„í˜¸ ì•ˆì˜ ì²« ë²ˆì§¸ ìœ„ì¹˜ë¡œ ì»¤ì„œ ì´ë™
                const firstBrace = newSymbol.indexOf('{');
                newCursorPos = cursorPos + firstBrace + 1;
            }
            
            mathInput.setSelectionRange(newCursorPos, newCursorPos);
            updateMathPreview();
        }

        function insertMathTemplate(template) {
            const mathInput = document.getElementById('mathInput');
            const cursorPos = mathInput.selectionStart;
            const textBefore = mathInput.value.substring(0, cursorPos);
            const textAfter = mathInput.value.substring(mathInput.selectionEnd);
            
            mathInput.value = textBefore + template + textAfter;
            mathInput.focus();
            
            // í…œí”Œë¦¿ì˜ ì²« ë²ˆì§¸ í¸ì§‘ ê°€ëŠ¥í•œ ìœ„ì¹˜ë¡œ ì»¤ì„œ ì´ë™
            let newCursorPos = cursorPos + template.length;
            if (template.includes('a')) {
                newCursorPos = cursorPos + template.indexOf('a');
            } else if (template.includes('x')) {
                newCursorPos = cursorPos + template.indexOf('x');
            }
            
            mathInput.setSelectionRange(newCursorPos, newCursorPos);
            updateMathPreview();
        }

        function updateMathPreview() {
            const mathInput = document.getElementById('mathInput');
            const mathPreview = document.getElementById('mathPreview');
            const latex = mathInput.value;
            
            if (latex.trim()) {
                mathPreview.innerHTML = `$$${latex}$$`;
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([mathPreview]).catch(err => {
                        mathPreview.innerHTML = `<span style="color: red;">ì˜¤ë¥˜: ${err.message}</span>`;
                    });
                }
            } else {
                mathPreview.innerHTML = '';
            }
        }

        function insertMathFromEditor() {
            const mathInput = document.getElementById('mathInput');
            const formula = mathInput.value.trim();
            if (formula) {
                const range = quill.getSelection(true);
                quill.deleteText(range.index, range.length);
                quill.insertEmbed(range.index, 'mathjax', formula, Quill.sources.USER);
                quill.insertText(range.index + 1, ' ', Quill.sources.SILENT);
                quill.setSelection(range.index + 2);
                closeMathModal();
            }
        }

        function closeMathModal() {
            const modal = document.getElementById('mathModal');
            if (modal) {
                modal.remove();
            }
        }

        function showMathTab(tabName) {
            // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
            const tabContents = document.querySelectorAll('.math-tab-content');
            tabContents.forEach(content => {
                content.style.display = 'none';
            });
            
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            const tabButtons = document.querySelectorAll('.math-tab-btn');
            tabButtons.forEach(btn => {
                if (btn.textContent.includes('ğŸ“ í•™ìƒìš©')) {
                    btn.style.background = '#f5f5f5';
                    btn.style.color = '#333';
                } else {
                    btn.style.background = '#f5f5f5';
                    btn.style.color = '#333';
                }
            });
            
            // ì„ íƒëœ íƒ­ ì½˜í…ì¸  ë³´ì´ê¸°
            const selectedContent = document.getElementById(`math-tab-${tabName}`);
            if (selectedContent) {
                selectedContent.style.display = 'block';
            }
            
            // ì„ íƒëœ íƒ­ ë²„íŠ¼ í™œì„±í™”
            const selectedButton = event.target;
            if (selectedButton.textContent.includes('ğŸ“ í•™ìƒìš©')) {
                selectedButton.style.background = '#28a745';
                selectedButton.style.color = 'white';
            } else {
                selectedButton.style.background = '#007cba';
                selectedButton.style.color = 'white';
            }
        }

        function handleMathKeyboard(event) {
            const mathInput = event.target;
            const cursorPos = mathInput.selectionStart;
            const text = mathInput.value;
            
            // Ctrl + / : ì£¼ì„ í† ê¸€
            if (event.ctrlKey && event.key === '/') {
                event.preventDefault();
                const lines = text.split('\n');
                const currentLine = text.substring(0, cursorPos).split('\n').length - 1;
                if (lines[currentLine].trim().startsWith('%')) {
                    lines[currentLine] = lines[currentLine].replace(/^%/, '');
                } else {
                    lines[currentLine] = '%' + lines[currentLine];
                }
                mathInput.value = lines.join('\n');
                updateMathPreview();
                return;
            }

            // Tab : ë‹¤ìŒ í¸ì§‘ ìœ„ì¹˜ë¡œ ì´ë™
            if (event.key === 'Tab') {
                event.preventDefault();
                const nextPos = findNextEditPosition(text, cursorPos);
                if (nextPos !== -1) {
                    mathInput.setSelectionRange(nextPos, nextPos);
                }
                return;
            }
            
            // Shift + Tab : ì´ì „ í¸ì§‘ ìœ„ì¹˜ë¡œ ì´ë™
            if (event.key === 'Tab' && event.shiftKey) {
                event.preventDefault();
                const prevPos = findPrevEditPosition(text, cursorPos);
                if (prevPos !== -1) {
                    mathInput.setSelectionRange(prevPos, prevPos);
                }
                return;
            }
            
            // ìë™ ê´„í˜¸ ì™„ì„±
            if (event.key === '(') {
                event.preventDefault();
                insertMathTemplate('\\left(\\right)');
                return;
            }
            
            if (event.key === '[') {
                event.preventDefault();
                insertMathTemplate('\\left[\\right]');
                return;
            }
            
            if (event.key === '{') {
                event.preventDefault();
                insertMathTemplate('\\left\\{\\right\\}');
                return;
            }
        }

        function findNextEditPosition(text, currentPos) {
            // ë‹¤ìŒ í¸ì§‘ ê°€ëŠ¥í•œ ìœ„ì¹˜ ì°¾ê¸° (ë¹ˆ ì¤‘ê´„í˜¸, ê´„í˜¸ ë“±)
            const patterns = [
                /\{\}/g,  // ë¹ˆ ì¤‘ê´„í˜¸
                /\\left\(\\right\)/g,  // ë¹ˆ ê´„í˜¸
                /\\left\[\\right\]/g,  // ë¹ˆ ëŒ€ê´„í˜¸
                /\\left\\{\\right\\}/g,  // ë¹ˆ ì¤‘ê´„í˜¸
                /\\left\|\\right\|/g   // ë¹ˆ ì ˆëŒ“ê°’
            ];
            
            for (let pattern of patterns) {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    if (match.index > currentPos) {
                        return match.index + 1; // ì¤‘ê´„í˜¸ ì•ˆì˜ ì²« ë²ˆì§¸ ìœ„ì¹˜
                    }
                }
            }
            return -1;
        }

        function findPrevEditPosition(text, currentPos) {
            // ì´ì „ í¸ì§‘ ê°€ëŠ¥í•œ ìœ„ì¹˜ ì°¾ê¸°
            const patterns = [
                /\{\}/g,
                /\\left\(\\right\)/g,
                /\\left\[\\right\]/g,
                /\\left\\{\\right\\}/g,
                /\\left\|\\right\|/g
            ];
            
            let lastMatch = -1;
            for (let pattern of patterns) {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    if (match.index < currentPos) {
                        lastMatch = match.index + 1;
                    }
                }
            }
            return lastMatch;
        }

        function openChemModal() {
            console.log('[CHEM] ëª¨ë‹¬ ì—´ê¸° ì‹œì‘');
            const modal = document.getElementById('chemModal');
            const canvas = document.getElementById('chem-sketch');

            if (!modal) {
                console.error('[CHEM] chemModal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            modal.style.display = 'block';
            console.log('[CHEM] ëª¨ë‹¬ í‘œì‹œë¨');

            // Kekule.js Composer ì´ˆê¸°í™”
            if (window.Kekule && window.Kekule.Editor) {
                try {
                    console.log('[CHEM] Kekule.js ë¡œë“œë¨, Composer ì´ˆê¸°í™” ì‹œì‘');
                    
                    // Canvas ëŒ€ì‹  div ì»¨í…Œì´ë„ˆ ì‚¬ìš©
                    const container = document.createElement('div');
                    container.id = 'chem-sketch-container';
                    container.style.width = '520px';
                    container.style.height = '360px';
                    container.style.border = '1px solid #ccc';
                    container.style.borderRadius = '4px';
                    
                    // ê¸°ì¡´ canvasë¥¼ containerë¡œ êµì²´ (ì•ˆì „í•˜ê²Œ)
                    if (canvas && canvas.parentNode) {
                        console.log('[CHEM] ê¸°ì¡´ canvas êµì²´');
                        canvas.parentNode.replaceChild(container, canvas);
                    } else {
                        console.log('[CHEM] canvasê°€ ì—†ê±°ë‚˜ parentNodeê°€ ì—†ìŒ, modalì— ì§ì ‘ ì¶”ê°€');
                        // canvasê°€ ì—†ê±°ë‚˜ parentNodeê°€ ì—†ëŠ” ê²½ìš°, modalì— ì§ì ‘ ì¶”ê°€
                        const modalContent = modal.querySelector('.modal-content');
                        if (modalContent) {
                            modalContent.appendChild(container);
                        } else {
                            console.error('[CHEM] modal-contentë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                            return;
                        }
                    }
                    
                    // Kekule Composer ì´ˆê¸°í™”
                    chemSketcher = new window.Kekule.Editor.Composer(container);
                    chemSketcher.setDimension(520, 360);
                    
                    console.log('[CHEM] Kekule.js Composer ì´ˆê¸°í™” ì„±ê³µ');
                } catch (e) {
                    console.error('[CHEM] Kekule.js Composer ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
                    // ëŒ€ì•ˆ: ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ ì…ë ¥ìœ¼ë¡œ ëŒ€ì²´
                    const container = document.createElement('div');
                    container.innerHTML = `
                        <p>í™”í•™ êµ¬ì¡° ê·¸ë¦¬ê¸° ë„êµ¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p>SMILES í‘œê¸°ë²•ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”:</p>
                        <input type="text" id="smiles-input" placeholder="ì˜ˆ: c1ccccc1 (ë²¤ì  )" style="width: 100%; padding: 8px; margin: 10px 0;">
                        <button onclick="insertSmilesFromInput()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px;">ì‚½ì…</button>
                    `;
                    
                    if (canvas && canvas.parentNode) {
                        canvas.parentNode.replaceChild(container, canvas);
                    } else {
                        const modalContent = modal.querySelector('.modal-content');
                        if (modalContent) {
                            modalContent.appendChild(container);
                        }
                    }
                }
            } else {
                console.warn('[CHEM] Kekule.jsê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                setTimeout(() => openChemModal(), 250);
            }
        }

        function closeChemModal() {
            const modal = document.getElementById('chemModal');
            modal.style.display = 'none';
            chemSketcher = null;
        }

        function insertSmilesFromInput() {
            const input = document.getElementById('smiles-input');
            if (input && input.value.trim()) {
                const smiles = input.value.trim();
                console.log('[CHEM] SMILES ì…ë ¥:', smiles);
                
                // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì—ë””í„°ì— SMILES ì‚½ì…
                if (inlineEditor) {
                    const range = inlineEditor.getSelection();
                    inlineEditor.insertText(range.index, `[í™”í•™êµ¬ì¡°: ${smiles}]`);
                } else if (quill) {
                    const range = quill.getSelection();
                    quill.insertText(range.index, `[í™”í•™êµ¬ì¡°: ${smiles}]`);
                }
                
                closeChemModal();
            }
        }

        function insertChemStructure() {
            if (!chemSketcher) {
                alert('ìŠ¤ì¼€ì²˜ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const chemObj = chemSketcher.getChemObj();
                if (chemObj) {
                    // SMILESë¡œ ë³€í™˜
                    const smiles = window.Kekule.IO.saveFormatData(chemObj, 'smi');
                    if (smiles) {
                        const range = quill.getSelection(true);
                        quill.insertEmbed(range.index, 'chem', smiles, Quill.sources.USER);
                        quill.setSelection(range.index + 1);
                        closeChemModal();
                    } else {
                        alert('í™”í•™ êµ¬ì¡°ë¥¼ SMILESë¡œ ë³€í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } else {
                    alert('í™”í•™ êµ¬ì¡°ë¥¼ ê·¸ë ¤ì£¼ì„¸ìš”.');
                }
            } catch (e) {
                console.error('í™”í•™ êµ¬ì¡° ì‚½ì… ì˜¤ë¥˜:', e);
                alert('í™”í•™ êµ¬ì¡°ë¥¼ ì‚½ì…í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function editChemStructure(node) {
            const currentValue = node.getAttribute('data-smiles');
            
            // ëª¨ë‹¬ ì—´ê¸°
            openChemModal();
            
            // ê¸°ì¡´ êµ¬ì¡°ë¥¼ ìŠ¤ì¼€ì²˜ì— ë¡œë“œ
            setTimeout(() => {
                if (chemSketcher && currentValue && window.Kekule) {
                    try {
                        const chemObj = window.Kekule.IO.loadFormatData(currentValue, 'smi');
                        if (chemObj) {
                            chemSketcher.setChemObj(chemObj);
                        }
                    } catch (e) {
                        console.warn('ê¸°ì¡´ êµ¬ì¡° ë¡œë“œ ì‹¤íŒ¨:', e);
                    }
                }
            }, 500);
        }

        // Network Status
        function checkNetworkStatus() {
            fetch(`${API_BASE}/questions/admin/questions?page=1&page_size=1`)
                .then(response => {
                    networkOnline = response.ok;
                    document.getElementById('networkStatus').innerHTML =
                        networkOnline ? '<span class="status-ok">online</span>' : '<span class="status-fail">offline</span>';
                })
                .catch(() => {
                    networkOnline = false;
                    document.getElementById('networkStatus').innerHTML = '<span class="status-fail">offline</span>';
                });
        }

        // API Functions
        async function fetchWithTimeout(url, options = {}, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal,
                    mode: 'cors'
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        window.searchByOriginalId = async function() {
            const originalId = document.getElementById('searchInput').value.trim();
            if (!originalId) return;

            try {
                console.log('[SEARCH] ê²€ìƒ‰ ì‹œì‘, ID:', originalId);
                const response = await fetchWithTimeout(
                    `${API_BASE}/questions/admin/questions?original_id=${originalId}`
                );

                console.log('[SEARCH] Response status:', response.status);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                console.log('[SEARCH] API ì‘ë‹µ:', data);
                console.log('[SEARCH] ë°ì´í„° íƒ€ì…:', typeof data, 'ë°°ì—´ì¸ê°€?', Array.isArray(data));

                // API ì‘ë‹µì´ ë°°ì—´ì¸ ê²½ìš° (mock API)
                if (Array.isArray(data) && data.length > 0) {
                    console.log('[SEARCH] ë°°ì—´ ì‘ë‹µ ì²˜ë¦¬, ì²« ë²ˆì§¸ í•­ëª©:', data[0]);
                    loadQuestionDetail(data[0].id);
                }
                // API ì‘ë‹µì´ ê°ì²´ì´ê³  questions ë°°ì—´ì„ ê°€ì§„ ê²½ìš°
                else if (data.questions && data.questions.length > 0) {
                    console.log('[SEARCH] ê°ì²´ ì‘ë‹µ ì²˜ë¦¬, questions:', data.questions);
                    loadQuestionDetail(data.questions[0].id);
                } else {
                    console.log('[SEARCH] ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ');
                    alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('[SEARCH] ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        window.searchRangeList = async function() {
            const originalId = document.getElementById('searchInput').value.trim();
            const count = document.getElementById('rangeCount').value;

            if (!originalId) return;

            try {
                const endId = count ? parseInt(originalId) + parseInt(count) - 1 : originalId;
                const promises = [];

                for (let id = parseInt(originalId); id <= endId; id++) {
                    promises.push(
                        fetchWithTimeout(`${API_BASE}/questions/${id}`)
                            .then(response => response.ok ? response.json() : null)
                            .catch(() => null)
                    );
                }

                const results = await Promise.all(promises);
                console.log('[LIST] API ì‘ë‹µë“¤:', results);

                // ìœ íš¨í•œ ê²°ê³¼ë§Œ í•„í„°ë§
                const validResults = results.filter(r => r && r.id);
                
                const questions = validResults.map(r => ({
                    id: r.id,
                    que_en_title: r.que_en_title || `Question ${r.id}`,
                    que_class: r.que_class || 'N/A'
                }));

                renderList(questions);
            } catch (error) {
                console.error('[LIST] ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function loadQuestionDetail(id) {
            try {
                const response = await fetchWithTimeout(`${API_BASE}/questions/${id}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                currentData = data;
                renderQuestionDetail(data);
                loadEditorContent(data);
            } catch (error) {
                console.error('[LOAD] ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ë¬¸ì œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function renderList(questions) {
            const container = document.getElementById('listContainer');
            container.innerHTML = questions.map(q => `
                <div class="list-item" onclick="loadQuestionDetail(${q.id})">
                    <strong>${q.que_en_title || 'Untitled'}</strong><br>
                    <small>ID: ${q.id} | Class: ${q.que_class || 'N/A'}</small>
                </div>
            `).join('');
        }

        function renderQuestionDetail(data) {
            document.getElementById('questionTitle').textContent = data.que_en_title || 'Question';

            const viewContent = document.getElementById('viewContent');
            viewContent.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <div class="section-header">
                        <h4 class="section-title">ë¬¸ì œ ì •ë³´</h4>
                    </div>
                    <p><strong>ID:</strong> ${data.id}</p>
                    <p><strong>Original ID:</strong> ${data.que_id}</p>
                    <p><strong>ê³¼ëª©:</strong> ${data.que_class || 'N/A'}</p>
                    <p><strong>í•™ë…„:</strong> ${data.que_grade || 'N/A'}</p>
                    <p><strong>ë‚œì´ë„:</strong> ${data.que_level || 'N/A'}</p>
                </div>
                <div style="margin-bottom: 1rem;">
                    <div class="section-header">
                        <h4 class="section-title">ì œëª©</h4>
                        <div class="section-actions">
                            <button onclick="editInline('title')">í¸ì§‘</button>
                        </div>
                    </div>
                    <div class="editable-content" id="titleContent" onclick="startInlineEdit('title')">
                        <div class="edit-indicator">âœï¸ í´ë¦­í•˜ì—¬ í¸ì§‘</div>
                        ${data.que_en_title || 'ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤.'}
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <div class="section-header">
                        <h4 class="section-title">ë¬¸ì œ</h4>
                        <div class="section-actions">
                            <button onclick="editInline('question')">í¸ì§‘</button>
                        </div>
                    </div>
                    <div class="editable-content" id="questionContent" onclick="startInlineEdit('question')">
                        <div class="edit-indicator">âœï¸ í´ë¦­í•˜ì—¬ í¸ì§‘</div>
                        ${renderField(data.question_en)}
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <div class="section-header">
                        <h4 class="section-title">í•´ì„¤</h4>
                        <div class="section-actions">
                            <button onclick="editInline('solution')">í¸ì§‘</button>
                        </div>
                    </div>
                    <div class="editable-content" id="solutionContent" onclick="startInlineEdit('solution')">
                        <div class="edit-indicator">âœï¸ í´ë¦­í•˜ì—¬ í¸ì§‘</div>
                        ${renderField(data.solution_en)}
                    </div>
                </div>
                ${data.hint_en ? `
                <div style="margin-bottom: 1rem;">
                    <div class="section-header">
                        <h4 class="section-title">íŒíŠ¸</h4>
                        <div class="section-actions">
                            <button onclick="editInline('hint')">í¸ì§‘</button>
                        </div>
                    </div>
                    <div class="editable-content" id="hintContent" onclick="startInlineEdit('hint')">
                        <div class="edit-indicator">âœï¸ í´ë¦­í•˜ì—¬ í¸ì§‘</div>
                        ${renderField(data.hint_en)}
                    </div>
                </div>
                ` : ''}
                <div style="margin-bottom: 1rem;">
                    <div class="section-header">
                        <h4 class="section-title">ë¦¬ì†ŒìŠ¤</h4>
                        <div class="section-actions">
                            <button onclick="editInline('resource')">í¸ì§‘</button>
                        </div>
                    </div>
                    <div class="editable-content" id="resourceContent" onclick="startInlineEdit('resource')">
                        <div class="edit-indicator">âœï¸ í´ë¦­í•˜ì—¬ í¸ì§‘</div>
                        ${renderField(data.que_en_resource || 'ë¦¬ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.')}
                    </div>
                </div>
            `;

            // Render MathJax in view content
            if (mathjaxReady) {
                MathJax.typesetPromise([viewContent]);
            }
        }

        function renderField(content) {
            if (!content) return '<em>ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</em>';

            // Process images
            let processedContent = content.replace(/\[ì´ë¯¸ì§€:\s*([^\]]+)\]/g, (match, imageName) => {
                return `<img src="${IMG_BASE}${imageName}" alt="${imageName}" style="max-width: 100%; height: auto; border: 1px solid var(--border-color); border-radius: 5px;">`;
            });

            return processedContent;
        }

        function loadEditorContent(data) {
            if (!quill) return;

            const content = data.question_en || '';
            quill.setContents([]);
            quill.pasteHTML(content);
            originalContent = quill.getContents();
        }

        function updatePreview() {
            if (!quill) return;

            const content = quill.root.innerHTML;
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = content;

            // Re-render MathJax in preview
            if (mathjaxReady) {
                MathJax.typesetPromise([previewContent]);
            }
        }

        async function saveCurrent() {
            if (!currentData || !quill) return;

            try {
                const content = quill.root.innerHTML;
                const updateData = {
                    ...currentData,
                    question_en: content
                };

                const response = await fetchWithTimeout(`${API_BASE}/questions/${currentData.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    originalContent = quill.getContents();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('[SAVE] ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function resetEditor() {
            if (quill && originalContent) {
                quill.setContents(originalContent);
            }
        }

        window.switchTab = function(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Update content based on tab
            if (tabName === 'raw' && currentData) {
                document.getElementById('rawContent').textContent = JSON.stringify(currentData, null, 2);
            }
        }

        function loadInitialData() {
            // Load initial question if search input has value
            const searchInput = document.getElementById('searchInput');
            if (searchInput.value) {
                searchByOriginalId();
            }
        }

        // Inline Editing Functions
        let currentEditingField = null;
        let inlineEditor = null;

        function startInlineEdit(fieldType) {
            console.log('[EDIT] í¸ì§‘ ì‹œì‘:', fieldType);
            
            // Check if Quill is loaded
            if (typeof Quill === 'undefined') {
                console.error('[EDIT] Quillì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
                alert('ì—ë””í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            console.log('[EDIT] Quill ë¡œë“œ í™•ì¸ë¨:', Quill);
            
            if (currentEditingField === fieldType) {
                console.log('[EDIT] ì´ë¯¸ í¸ì§‘ ì¤‘:', fieldType);
                return;
            }
            
            const contentElement = document.getElementById(fieldType + 'Content');
            if (!contentElement) {
                console.error('[EDIT] ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', fieldType + 'Content');
                return;
            }
            console.log('[EDIT] ìš”ì†Œ ì°¾ìŒ:', contentElement);

            // Create inline editor
            const editorContainer = document.createElement('div');
            editorContainer.className = 'editor-container';
            editorContainer.style.height = '400px'; // ë†’ì´ ì¦ê°€
            editorContainer.style.marginTop = '0.5rem';
            editorContainer.style.maxHeight = '500px'; // ìµœëŒ€ ë†’ì´ ì„¤ì •
            editorContainer.style.overflowY = 'auto'; // ìŠ¤í¬ë¡¤ í™œì„±í™”
            
            // Add container to DOM first
            contentElement.innerHTML = '';
            contentElement.appendChild(editorContainer);
            contentElement.classList.add('editing');

            // Wait for DOM to be ready
            setTimeout(() => {
                // Initialize Quill for inline editing
                console.log('[EDIT] Quill ì—ë””í„° ìƒì„± ì¤‘...');
                try {
                    inlineEditor = new Quill(editorContainer, {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'header': [1, 2, 3, false] }],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                ['blockquote', 'code-block'],
                                ['link', 'image'],
                                ['formula', 'chem'], // MathJaxì™€ ChemDoodle ë²„íŠ¼ ì¶”ê°€
                                ['clean']
                            ]
                        }
                    });
                    console.log('[EDIT] Quill ì—ë””í„° ìƒì„± ì™„ë£Œ:', inlineEditor);
                    
                    // Add custom buttons to inline editor toolbar
                    addCustomButtonsToInlineEditor();
                    
                    // Continue with content setting
                    setEditorContent();
                } catch (error) {
                    console.error('[EDIT] Quill ì—ë””í„° ìƒì„± ì‹¤íŒ¨:', error);
                    return;
                }
            }, 100);

            // Function to set editor content after Quill is initialized
            function setEditorContent() {
                // Check if toolbar is visible
                console.log('[EDIT] íˆ´ë°” í™•ì¸ ì¤‘...');
                const toolbarContainer = inlineEditor.container.parentElement.querySelector('.ql-toolbar');
                if (toolbarContainer) {
                    console.log('[EDIT] íˆ´ë°” ì»¨í…Œì´ë„ˆ ì°¾ìŒ:', toolbarContainer);
                    console.log('[EDIT] íˆ´ë°” ìŠ¤íƒ€ì¼:', window.getComputedStyle(toolbarContainer));
                    console.log('[EDIT] íˆ´ë°” í‘œì‹œ:', toolbarContainer.style.display);
                } else {
                    console.log('[EDIT] íˆ´ë°” ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - ì •ìƒì¼ ìˆ˜ ìˆìŒ');
                }

                // Set content based on field type
                let currentContent = '';
                if (fieldType === 'title') {
                    currentContent = currentData.que_en_title || '';
                } else if (fieldType === 'resource') {
                    currentContent = currentData.que_en_resource || '';
                } else {
                    currentContent = currentData[fieldType + '_en'] || '';
                }
                inlineEditor.pasteHTML(currentContent);
                console.log('[EDIT] ì—ë””í„° ë‚´ìš© ì„¤ì • ì™„ë£Œ');

                // Add save/cancel buttons
                const buttonContainer = document.createElement('div');
                buttonContainer.style.marginTop = '0.5rem';
                buttonContainer.innerHTML = `
                    <button onclick="saveInlineEdit('${fieldType}')">ì €ì¥</button>
                    <button onclick="cancelInlineEdit('${fieldType}')">ì·¨ì†Œ</button>
                `;
                contentElement.appendChild(buttonContainer);

                currentEditingField = fieldType;
            }
        }

        function saveInlineEdit(fieldType) {
            console.log('[EDIT] ì €ì¥ ì‹œì‘:', fieldType);
            
            if (!inlineEditor || !currentData) {
                console.error('[EDIT] ì €ì¥ ì‹¤íŒ¨: ì—ë””í„° ë˜ëŠ” ë°ì´í„° ì—†ìŒ');
                return;
            }
            
            const content = inlineEditor.root.innerHTML;
            console.log('[EDIT] ì €ì¥í•  ë‚´ìš©:', content);
            
            // Update data based on field type
            if (fieldType === 'title') {
                currentData.que_en_title = content;
                // Update page title
                document.getElementById('questionTitle').textContent = content || 'Question';
            } else if (fieldType === 'resource') {
                currentData.que_en_resource = content;
            } else {
                currentData[fieldType + '_en'] = content;
            }
            
            // Update the display
            const contentElement = document.getElementById(fieldType + 'Content');
            if (!contentElement) {
                console.error('[EDIT] ì €ì¥í•  ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', fieldType + 'Content');
                return;
            }
            
            contentElement.innerHTML = `
                <div class="edit-indicator">âœï¸ í´ë¦­í•˜ì—¬ í¸ì§‘</div>
                ${renderField(content)}
            `;
            contentElement.classList.remove('editing');
            
            // Re-render MathJax
            if (mathjaxReady) {
                MathJax.typesetPromise([contentElement]);
            }
            
            currentEditingField = null;
            inlineEditor = null;
            console.log('[EDIT] ì €ì¥ ì™„ë£Œ');
        }

        function cancelInlineEdit(fieldType) {
            console.log('[EDIT] ì·¨ì†Œ ì‹œì‘:', fieldType);
            const contentElement = document.getElementById(fieldType + 'Content');
            
            if (!contentElement) {
                console.error('[EDIT] ì·¨ì†Œí•  ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', fieldType + 'Content');
                return;
            }
            
            // Get original content based on field type
            let originalContent = '';
            if (fieldType === 'title') {
                originalContent = currentData.que_en_title || '';
            } else if (fieldType === 'resource') {
                originalContent = currentData.que_en_resource || '';
            } else {
                originalContent = currentData[fieldType + '_en'] || '';
            }
            
            console.log('[EDIT] ì›ë³¸ ë‚´ìš© ë³µì›:', originalContent);
            
            contentElement.innerHTML = `
                <div class="edit-indicator">âœï¸ í´ë¦­í•˜ì—¬ í¸ì§‘</div>
                ${renderField(originalContent)}
            `;
            contentElement.classList.remove('editing');
            
            // Re-render MathJax
            if (mathjaxReady) {
                MathJax.typesetPromise([contentElement]);
            }
            
            currentEditingField = null;
            inlineEditor = null;
            console.log('[EDIT] ì·¨ì†Œ ì™„ë£Œ');
        }

        function editInline(fieldType) {
            startInlineEdit(fieldType);
        }

        // Add custom buttons to inline editor
        function addCustomButtonsToInlineEditor() {
            if (!inlineEditor) return;
            
            const toolbar = inlineEditor.getModule('toolbar');
            const toolbarContainer = inlineEditor.container.parentElement.querySelector('.ql-toolbar');
            
            if (toolbarContainer) {
                // Add MathJax button
                const formulaButton = document.createElement('button');
                formulaButton.innerHTML = 'fx';
                formulaButton.title = 'ìˆ˜ì‹ ì‚½ì…';
                formulaButton.onclick = insertMathFormula;
                formulaButton.style.marginLeft = '5px';
                toolbarContainer.appendChild(formulaButton);
                
                // Add ChemDoodle button
                const chemButton = document.createElement('button');
                chemButton.innerHTML = 'ğŸ§ª';
                chemButton.title = 'í™”í•™ êµ¬ì¡° ì‚½ì…';
                chemButton.onclick = openChemModal;
                chemButton.style.marginLeft = '5px';
                toolbarContainer.appendChild(chemButton);
            }
        }

        // Resizable Panels
        function initResizablePanels() {
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const resizeHandle = document.getElementById('resizeHandle');

            let isResizing = false;

            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;

                const containerWidth = document.querySelector('.container').offsetWidth;
                const newLeftWidth = e.clientX;
                const minWidth = 250;
                const maxWidth = containerWidth - 250;

                if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
                    leftPanel.style.width = newLeftWidth + 'px';
                }
            });

            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // Event Listeners
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchByOriginalId();
            }
        });

        // Close modal when clicking outside
        document.getElementById('chemModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeChemModal();
            }
        });

        // Initialize resizable panels
        document.addEventListener('DOMContentLoaded', function() {
            initResizablePanels();
        });

        function insertChemTemplate(smiles) {
            // í™”í•™ êµ¬ì¡°ë¥¼ Quill ì—ë””í„°ì— ì§ì ‘ ì‚½ì…
            const range = quill.getSelection(true);
            quill.insertEmbed(range.index, 'chem', smiles, Quill.sources.USER);
            quill.setSelection(range.index + 1, 0, Quill.sources.USER);
            
            // ìˆ˜ì‹ ì—ë””í„° ëª¨ë‹¬ ë‹«ê¸°
            closeMathModal();
        }

        function insertSmilesFromInput() {
            const input = document.getElementById('smiles-input');
            if (input && input.value.trim()) {
                const range = quill.getSelection(true);
                quill.insertEmbed(range.index, 'chem', input.value.trim(), Quill.sources.USER);
                quill.setSelection(range.index + 1, 0, Quill.sources.USER);
                closeChemModal();
            }
        }
    </script>
</body>
</html>
