apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: validate-crds-hpa-servicemonitor-externalsecret
spec:
  validationFailureAction: Audit
  background: false
  rules:
    - name: validate-hpa
      match:
        any:
          - resources:
              kinds:
                - HorizontalPodAutoscaler
      validate:
        message: HPA should target a workload and set a reasonable CPU target.
        pattern:
          spec:
            scaleTargetRef:
              kind: "*"
              name: "*"
            =(metrics):
              - type: Resource
                resource:
                  name: cpu
                  target:
                    type: Utilization
                    averageUtilization: ">=50"
    - name: validate-servicemonitor
      match:
        any:
          - resources:
              kinds:
                - ServiceMonitor
      validate:
        message: ServiceMonitor should specify endpoints with path and interval.
        pattern:
          spec:
            endpoints:
              - path: "*"
                interval: "*"
            selector:
              matchLabels:
                "*": "*"
    - name: validate-externalsecret
      match:
        any:
          - resources:
              kinds:
                - ExternalSecret
      validate:
        message: ExternalSecret should reference a SecretStore and target secret name.
        pattern:
          spec:
            secretStoreRef:
              name: "*"
              kind: "*"
            target:
              name: "*"
