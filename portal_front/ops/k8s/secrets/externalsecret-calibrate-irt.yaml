# cSpell:ignore externalsecrets
# ExternalSecret configuration for calibrate-irt CronJob
#
# This configuration uses External Secrets Operator (ESO) to inject secrets
# from Google Secret Manager (GSM) into Kubernetes Secrets.
#
# Prerequisites:
# 1. External Secrets Operator installed in cluster
# 2. ClusterSecretStore configured for GCP Secret Manager
# 3. Secrets stored in GSM:
#    - seedtest/database-url (for DATABASE_URL)
#    - r-irt-plumber/token (for R_IRT_INTERNAL_TOKEN)
#
# Usage:
# 1. Apply ClusterSecretStore (if not exists)
# 2. Update remoteRef.key paths to match your GSM secret paths
# 3. Apply this ExternalSecret: kubectl apply -f externalsecret-calibrate-irt.yaml
# 4. Verify Secret creation: kubectl -n seedtest get secret calibrate-irt-credentials
# 5. Update CronJob to reference the Secret

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: calibrate-irt-credentials
  namespace: seedtest
spec:
  refreshInterval: "1h"  # Refresh every hour
  secretStoreRef:
    name: gcpsm-secret-store  # Name of your SecretStore
    kind: SecretStore
  target:
    name: calibrate-irt-credentials  # The Kubernetes Secret to create
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    # Database URL for IRT calibration job
    - secretKey: DATABASE_URL
      remoteRef:
        key: seedtest/database-url  # Path in GSM
        # GSM path: projects/univprepai/secrets/seedtest-database-url/versions/latest
        # Expected format: postgresql://user:pass@host:5432/dbname
    
    # R IRT Plumber internal token (optional)
    - secretKey: R_IRT_INTERNAL_TOKEN
      remoteRef:
        key: r-irt-plumber/token  # Path in GSM
        # GSM path: projects/univprepai/secrets/r-irt-plumber-token/versions/latest
        version: latest  # Optional: specific version or 'latest'

---
# Alternative: Direct Secret creation (if not using ESO)
# 
# kubectl -n seedtest create secret generic calibrate-irt-credentials \
#   --from-literal=DATABASE_URL='postgresql://user:pass@host:5432/dbname' \
#   --from-literal=R_IRT_INTERNAL_TOKEN='<token>' \
#   --dry-run=client -o yaml | kubectl apply -f -

---
# ClusterSecretStore example for Google Secret Manager
# (Create this first if using ESO with GSM)
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: gcp-secret-store
spec:
  provider:
    gcpsm:
      projectId: univprepai  # Your GCP project ID
      auth:
        secretRef:
          # Reference to GCP service account key Secret
          secretAccessKeySecretRef:
            name: eso-gcp-credentials
            key: secret-access-key
            namespace: seedtest
      # Optional: version filter
      # version: "latest"

---
# GCP Service Account Key Secret (for ESO authentication)
# This Secret must be created manually from a GCP service account key
#
# How to create:
# 1. Create a GCP service account with Secret Manager Secret Accessor role
# 2. Download the service account key JSON
# 3. Extract the private_key field
# 4. Create Secret:
#    kubectl -n seedtest create secret generic eso-gcp-credentials \
#      --from-literal=secret-access-key="$(cat sa-key.json | jq -r .private_key)"

apiVersion: v1
kind: Secret
metadata:
  name: eso-gcp-credentials
  namespace: seedtest
type: Opaque
# Note: This Secret must be created manually with the GCP service account key
# The secret-access-key should contain the private_key from the JSON key file
stringData:
  secret-access-key: |
    # Replace with actual private_key from GCP service account JSON
    # This is a placeholder - actual key must be provided

