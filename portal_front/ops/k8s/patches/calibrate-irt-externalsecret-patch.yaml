# Kubernetes Patch for calibrate-irt CronJob to use ExternalSecret
#
# This patch updates the calibrate-irt-weekly CronJob to use secrets
# managed by External Secrets Operator (ESO) instead of manually created secrets.
#
# Prerequisites:
# 1. ExternalSecret 'calibrate-irt-credentials' must be deployed and synced
# 2. Verify Secret exists: kubectl -n seedtest get secret calibrate-irt-credentials
#
# Apply this patch:
#   kubectl -n seedtest patch cronjob calibrate-irt-weekly --patch-file calibrate-irt-externalsecret-patch.yaml
#
# Or apply as strategic merge:
#   kubectl -n seedtest patch cronjob calibrate-irt-weekly --type strategic --patch "$(cat calibrate-irt-externalsecret-patch.yaml)"

apiVersion: batch/v1
kind: CronJob
metadata:
  name: calibrate-irt-weekly
  namespace: seedtest
spec:
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: calibrate-irt
            env:
            # DATABASE_URL from ExternalSecret
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: calibrate-irt-credentials  # Changed from seedtest-db-credentials
                  key: DATABASE_URL
                  optional: false
            
            # R_IRT_INTERNAL_TOKEN from ExternalSecret
            - name: R_IRT_INTERNAL_TOKEN
              valueFrom:
                secretKeyRef:
                  name: calibrate-irt-credentials  # Changed from r-irt-credentials
                  key: R_IRT_INTERNAL_TOKEN
                  optional: true
