# 교사용 클래스 모니터 대시보드

## 목표
**교사가 1분 이내에 介入(개입) 대상을 결정**할 수 있도록 클래스 상태를 시각화하고 리스크를 자동 탐지합니다.

## 핵심 화면 구성

### 1. 클래스 스냅샷 (6개 KPI)
- **평균 θ**: 클래스 전체 능력 수준
- **중앙값 θ**: 중심 경향성
- **상·하위 10% 구간**: P10 ~ P90 범위 (분산도)
- **주간 성장률 Δθ**: 최근 7일 vs 이전 7일 평균 변화
- **출석 안정도**: 평균 결석률 · 지각률
- **리스크 카운트**: 개선 저조 / 출석 불규칙 / 문항 반응 이상 학생 수

### 2. 리스크 카드 (3종)
| 리스크 유형 | 기준 (환경변수로 조정 가능) | 색상 |
|------------|---------------------------|------|
| **개선 저조** | Δ7d < 0.02 (RISK_THETA_DELTA) | 30% 이상: 빨강, 1명 이상: 노랑 |
| **출석 불규칙** | 결석+지각 > 25% (RISK_ATTENDANCE) | 20% 이상: 빨강, 1명 이상: 노랑 |
| **문항 반응 이상** | guess_rate > 15% OR omit_rate > 12% | 15% 이상: 빨강, 1명 이상: 노랑 |

### 3. 그룹 θ 히스토그램
- **24 bins**, 5개 버킷으로 색상 구분:
  - 매우낮음 (≤-1.5): 빨강 (#d32f2f)
  - 낮음 (-1.5~-0.5): 주황 (#f57c00)
  - 중간 (-0.5~0.5): 노랑 (#fbc02d)
  - 높음 (0.5~1.5): 연두 (#689f38)
  - 매우높음 (>1.5): 초록 (#388e3c)

### 4. 버킷별 추천 액션 (CTA 버튼)
각 버킷별 학생 수와 추천 액션을 클릭형 버튼으로 제공:
- **매우낮음 → 보정 과제 배정**
- **낮음 → 보충수업 추천**
- **중간 → 핵심 연습 강화**
- **높음 → 상향 도전**
- **매우높음 → 심화/확장**

*(현재 버전: 클릭 시 알림 표시. 추후 과제 배정 API 연동 가능)*

### 5. 학생 목록 (드릴다운)
- **다중 정렬**: `risk_score DESC, theta ASC, delta_7d ASC`
  - **risk_score**: 개선 저조(3점) + 출석 불규칙(2점) + 반응 이상(1점)
- **컬럼**:
  - student_id, student_name, theta, delta_7d, absences_14d, tardies_14d, guess_rate, omit_rate, weak_tags
- **행 클릭 → 모달 상세**:
  - 최근 4주 θ 스파크라인 (plotly)
  - 출석 타임라인 (present/tardy/absent 색상 구분)
  - 취약 스킬태그 TOP3

## 권한/필터

프록시가 주입한 헤더 기반:
- `X-User`: 사용자 ID
- `X-Org-Id`: 조직 ID (org 스코프 필터)
- `X-Roles`: 역할 (teacher, admin 등)

로컬 테스트 시 환경변수 사용:
```bash
export DEV_USER=teacher01
export DEV_ORG_ID=org_001
export DEV_ROLES=teacher
```

## 성능 최적화

- **Arrow dataset**: Parquet 파티션 (org_id, class_id)으로 푸시다운/프루닝 적용
- **지연 수집**: 요약 통계 먼저 계산 후 필요 시점에 `collect()`
- **스레드 활성화**: `options(arrow.use_threads = TRUE)`

## 실행

### 종속 패키지
```r
install.packages(c("shiny", "shinydashboard", "DT", "arrow", "dplyr", "plotly", "lubridate", "stringr", "tidyr", "tibble"))
```

### 로컬 실행
```bash
# 기본 포트 8081
Rscript -e 'shiny::runApp("portal_front/dashboard/app_teacher.R", host="0.0.0.0", port=8081)'

# 리스크 임계값 커스터마이징
export RISK_THETA_DELTA=0.03
export RISK_ATTENDANCE=0.30
export RISK_GUESS=0.20
export RISK_OMIT=0.15
Rscript -e 'shiny::runApp("portal_front/dashboard/app_teacher.R", host="0.0.0.0", port=8081)'
```

### 프로덕션 배포
nginx 리버스 프록시 + JWT 헤더 주입 패턴:
```nginx
location /dashboard/teacher/ {
    proxy_pass http://localhost:8081/;
    proxy_set_header X-User $jwt_claim_sub;
    proxy_set_header X-Org-Id $jwt_claim_org_id;
    proxy_set_header X-Roles $jwt_claim_roles;
}
```

참고: `infra/nginx/dashboard.dreamseedai.com.conf` 예제

## 임의 데이터 부트스트랩

`DATASET_ROOT` 미지정 시 자동으로 `data/datasets/`에 demo 데이터 생성:
- **classes**: org_id, class_id, class_name (10개 조직 × 10개 클래스)
- **students**: 클래스당 30명
- **student_theta**: 최근 90일 일별 θ 시계열
- **attendance**: 최근 90일 일별 출결 (present/tardy/absent)
- **skill_weakness**: 학생별 취약 스킬태그 TOP3
- **response_stats**: 학생별 guess_like_rate, omit_rate

Parquet 포맷 + org_id/class_id 파티션으로 저장

## 튜닝 포인트 (1분 의사결정 최적화)

### 1. 리스크 임계값 조정
환경변수로 학교 정책 반영:
```bash
export RISK_THETA_DELTA=0.02      # 주간 성장 임계
export RISK_ATTENDANCE=0.25       # 결석+지각 비율
export RISK_GUESS=0.15            # guess_like_rate
export RISK_OMIT=0.12             # omit_rate
```

### 2. 학생 테이블 기본 정렬
현재: **리스크 우선 → 낮은 θ → 낮은 Δ7d** 순
- risk_score: 다중 리스크 가중합 (개선 저조 3점, 출석 2점, 반응 이상 1점)
- 필요 시 컬럼 헤더 클릭으로 재정렬 가능

### 3. 버킷별 CTA 확장 (추후)
현재는 알림만 표시. 다음 단계:
- **보정 과제 배정 API**: `POST /api/assignments` (학생 ID 리스트 + 과제 템플릿)
- **보충수업 추천 워크플로**: 교사 일정 + 학생 가용 시간 매칭
- **상향 도전 콘텐츠 큐레이션**: 개인별 관심사 × 능력 수준 추천

### 4. 문항 반응 이상치 카드 추가
현재 구현됨:
- **리스크: 문항 반응 이상** value box (우상단)
- **학생 테이블**: guess_rate, omit_rate 컬럼 포함
- **다중 정렬**: risk_score에 반응 이상 가중치 포함

추가 확장 아이디어:
- 이상 패턴별 세부 카드 (pure guessing / strategic omit / rapid-fire)
- 문항별 이상치 분포 히트맵

## 연동 가능한 시스템

- **학사 출결 시스템**: attendance 데이터 실시간 ETL
- **평가 시스템**: response_stats 연계 (문항 반응 시간, 정답률)
- **과제 관리 API**: 버킷별 CTA → 자동 배정
- **IdP (Keycloak/Auth0)**: JWT 역할 매핑 (teacher, admin, principal)

## 참고 문서

- `infra/nginx/README.md`: JWT 검증 및 헤더 주입 패턴
- `infra/systemd/README.md`: Shiny 앱 서비스 등록
- `portal_front/dashboard/app.R`: 관리자용 대시보드 (org/role 필터 예제)

## 라이선스
DreamSeed AI 내부용
